<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>SID 98 - Enterprise (v7.2 - Busca R√°pida)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* --- CORE WINDOWS 98 STYLES --- */
    :root { --win-grey:#c0c0c0; --win-blue:#000080; }
    body { font-family:'Tahoma',sans-serif; background:#008080; margin:0; height:100vh; overflow:hidden; display:flex; justify-content:center; align-items:center; }
    
    .win-window { background:var(--win-grey); border:2px outset #fff; box-shadow:4px 4px 10px rgba(0,0,0,0.5); display:flex; flex-direction:column; }
    .title-bar { background:linear-gradient(90deg,var(--win-blue),#1084d0); color:#fff; padding:3px 4px; font-weight:bold; font-size:13px; display:flex; justify-content:space-between; align-items:center; }
    
    /* WINDOW CONTROLS */
    .controls-group { display:flex; gap:2px; }
    .btn-win { background:var(--win-grey); border:1px outset #fff; width:18px; height:18px; font-size:10px; line-height:1; font-weight:bold; cursor:pointer; text-align:center; color:#000; }
    .btn-win:hover { background: #e0e0e0; }
    .btn-win.close { color: #d0000; font-size: 12px; }
    .btn-win:active { border-style:inset; }

    /* LAYOUT */
    #mainApp { width:98%; height:98vh; max-width:1400px; display:none; } 
    .app-body { flex:1; display:flex; padding:8px; gap:8px; overflow:hidden; }
    .sidebar { width:220px; display:flex; flex-direction:column; gap:6px; }
    .nav-btn { width: 100%; text-align: left; padding: 8px; display: flex; align-items: center; gap: 8px; }
    .nav-btn.active { background: #fff; border-style: inset; font-weight: bold; }
    .nav-btn.disabled { color: #666; cursor: not-allowed; }

    .content-area { flex:1; background:#fff; border:2px inset #fff; display:flex; flex-direction:column; }
    
    /* TABELA */
    .table-container { flex:1; overflow:auto; }
    table { width:100%; border-collapse:collapse; font-size:11px; }
    th { background:var(--win-grey); position:sticky; top:0; text-align:left; border:1px outset #fff; padding:5px; z-index:10; }
    td { border:1px solid #ddd; padding:5px; } 
    tr:hover { background:#000080; color:#fff; }
    .status-badge { padding: 2px 5px; border-radius: 3px; font-weight: bold; font-size: 10px; border: 1px solid #999; }
    /* ATEN√á√ÉO: CSS para 6 colunas na info-grid */
    .info-grid { 
    display:grid; 
    grid-template-columns:repeat(6,1fr); /* Ajustado para 6 colunas */
    background:#e0e0e0; 
    border:2px inset #fff; 
    padding:5px; 
    }
    .info-item span { display:block; color:#000080; font-weight:bold; font-size:11px; }
    
    /* MODAL GIGANTE */
    .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:9999; }
    .modal-box { width:95%; height:95%; background:var(--win-grey); }
    .modal-content { padding:10px; height:100%; display:flex; flex-direction:column; gap:10px; }
    
    /* EDITOR GRID */
    .editor-layout { flex:1; display:grid; grid-template-columns: 1fr 1fr; gap:10px; overflow:hidden; }
    .col-left, .col-right { display:flex; flex-direction:column; gap:10px; }
    .group-box { border:1px solid #999; padding:5px; display:flex; flex-direction:column; background:#f0f0f0; flex:1; }
    textarea { width:100%; border:2px inset #fff; font-family:'Courier New'; resize:none; flex:1; padding:5px; }
    
    /* TASKBAR BUTTON STYLE */
    .btn-taskbar { background:var(--win-grey); border:2px outset #fff; padding: 5px 15px; font-weight: bold; font-size: 14px; cursor: pointer; }
    .btn-taskbar:active { border-style: inset; }

    /* CARRINHO DE MATERIAIS - NOVO DESIGN */
    .cart-controls { display:flex; flex-direction:column; gap:5px; margin-bottom:10px; }
    .search-box { display:flex; gap:5px; }
    .search-box input { flex:1; padding:4px; font-size:11px; border:2px inset #fff; }
    .type-selector { display:flex; gap:5px; }
    .type-selector select { flex:1; padding:4px; font-size:11px; border:2px outset #fff; }
    .item-selector { display:flex; gap:5px; }
    .item-selector select { flex:1; padding:4px; font-size:11px; border:2px outset #fff; }
    .quantity-controls { display:flex; gap:5px; align-items:center; }
    .quantity-controls input { width:50px; padding:4px; font-size:11px; border:2px inset #fff; text-align:center; }
    
    .cart-list { border:2px inset #fff; background:#fff; padding:5px; max-height:200px; overflow-y:auto; font-size:11px; }
    .cart-item { display:flex; justify-content:space-between; padding:3px; border-bottom:1px dotted #ccc; }
    .cart-del { color:red; cursor:pointer; font-weight:bold; padding:0 5px; }

    /* SUGEST√ïES DE BUSCA */
    .suggestions-box { 
    position: absolute; 
    background: white; 
    border: 2px outset #fff; 
    max-height: 150px; 
    overflow-y: auto; 
    z-index: 1000; 
    display: none;
    font-size: 11px;
    }
    .suggestion-item:hover { 
    background: #000080; 
    color: white; 
    }
    
    /* ESTILOS DE EVID√äNCIA */
    .evidence-area {
    padding: 5px;
    border: 2px inset #fff;
    background: #f0f0f0;
    min-height: 100px;
    }
    .file-preview {
    display: inline-block;
    margin: 3px;
    padding: 3px;
    border: 1px solid #aaa;
    background: #fff;
    font-size: 10px;
    }
    .file-preview .remove-btn {
    color: red;
    font-weight: bold;
    cursor: pointer;
    margin-left: 5px;
    }
  </style>
</head>
<body onload="checkLoginState()">

  <div id="taskbarBtn" style="position:fixed; bottom:10px; right:10px; z-index:9999; display:none;">
    <button class="btn-taskbar" onclick="restoreApp()">üñ•Ô∏è SID 98</button>
  </div>
  
  <div id="telaLogin" class="win-window" style="width:300px;">
    <div class="title-bar"><span>üîí Login SID 98</span></div>
    <div style="padding:20px;">
    <label style="font-size:11px; font-weight:bold;">E-mail Corporativo:</label>
    <input type="text" id="emailLogin" style="width:100%; margin-bottom:10px; padding:4px;">
    <button class="btn-98 primary" style="width:100%" onclick="login()">ENTRAR</button>
    </div>
  </div>

  <div id="mainApp" class="win-window">
    <div class="title-bar" id="appTitleBar">
    <span>GERENCIA OPERACIONAL BACKBONE</span>
    <div class="controls-group">
    <div class="btn-win" onclick="minimizeApp()">_</div>
    <div class="btn-win" onclick="toggleMaximize()">‚ñ°</div>
    <div class="btn-win close" onclick="closeApp()">X</div>
    </div>
    </div>
    
    <div class="app-body">
    <div class="sidebar">
    <div style="border:2px groove #fff; padding:5px; margin-bottom:5px;">
    <input type="text" id="termo" placeholder="ID ou Nome..." style="width:100%; padding:3px;" onkeydown="if(event.key=='Enter') buscar()">
    <button class="btn-98" style="width:100%; margin-top:4px;" onclick="buscar()">üîé Localizar Obra</button>
    </div>

    <button class="btn-98 nav-btn active" onclick="alert('M√≥dulo Ativo')">
    üõ†Ô∏è <b>SEG.55 - MANUTEN√á√ÉO</b>
    </button>
    
    <button class="btn-98 nav-btn disabled" onclick="alert('üöß M√≥dulo SEG.63 em Constru√ß√£o!')">
    üì° SEG.63 - MELHORIA (DC)
    </button>
    
    <button class="btn-98 nav-btn disabled" onclick="alert('üöß M√≥dulo Financeiro em Constru√ß√£o!')">
    üí∞ SALDO GESTECH GERENCIAL
    </button>
    
    <button class="btn-98 nav-btn disabled" onclick="alert('üöß M√≥dulo Escala em Constru√ß√£o!')">
    üìÖ ESCALA PLANT√ÉO T√âCNICO
    </button>

    <button class="btn-98 nav-btn disabled" onclick="alert('üöß M√≥dulo Supervis√£o em Constru√ß√£o!')">
    üëÆ SUPERVISORES PLANT√ÉO
    </button>
    </div>

    <div class="content-area">
    <div class="table-container">
    <table id="tbResult">
    <thead>
    <tr>
    <th width="8%">ID</th>
    <th width="8%">Operadora</th>
    <th width="15%">Descri√ß√£o</th>
    <th width="8%">Status</th>
    <th width="8%">Supervisor</th>
    <th width="8%">T√©cnico</th> <th width="15%">M√°scara BA</th>
    <th width="10%">Aplica√ß√£o</th>
    <th width="10%">Pend√™ncia</th>
    <th width="8%" style="text-align:center">A√ß√£o</th>
    </tr>
    </thead>
    <tbody></tbody>
    </table>
    <div id="msgInicial" style="padding:50px; text-align:center; color:#888;">
    <p>Utilize a busca lateral para carregar as obras do SEG.55.</p>
    </div>
    </div>
    </div>
    </div>
    
    <div style="background:var(--win-grey); border-top:2px groove #fff; padding:2px 5px; font-size:10px; display:flex; justify-content:space-between;">
    <span id="userDisplay"></span>
    <span>Base Conectada: BASE_DASH_OBRAS</span>
    <span>Status: Online v7.2</span>
    </div>
  </div>

  <div id="modalEdicao" class="modal-overlay">
    <div class="modal-box win-window">
    <div class="title-bar">
    <span id="lblModalTitulo">FICHA T√âCNICA</span>
    <div class="controls-group">
    <div class="btn-win" onclick="closeModal()">X</div>
    </div>
    </div>
    
    <div class="modal-content">
    <input type="hidden" id="hdnCod">
    
    <div class="info-grid">
    <div class="info-item"><label>ID:</label><span id="vID">-</span></div>
    <div class="info-item"><label>DESC:</label><span id="vDesc">-</span></div>
    <div class="info-item"><label>OP:</label><span id="vOp">-</span></div>
    <div class="info-item"><label>STATUS:</label><span id="vSt">-</span></div>
    <div class="info-item"><label>SUP:</label><span id="vSup">-</span></div>
    <div class="info-item"><label>T√âCNICO:</label><span id="vTec">-</span></div> </div>

    <div class="editor-layout">
    <div class="col-left">
    <div class="group-box">
    <div class="group-title">1. M√ÅSCARA / RELAT√ìRIO T√âCNICO</div>
    <textarea id="txtMas" placeholder="Descreva o servi√ßo..."></textarea>
    </div>
    
    <div class="group-box" style="background:#fff0f0; border-color:red;">
    <div class="group-title" style="color:red;">3. PEND√äNCIAS / DEVOLU√á√ÉO</div>
    <textarea id="txtPen" placeholder="Motivo de devolu√ß√£o..."></textarea>
    </div>
    
    <div class="group-box" style="flex: 0 0 160px;">
    <div class="group-title">4. EVID√äNCIAS (FOTOS) - M√°x. 10 arquivos</div>
    <input type="file" id="fileUpload" multiple accept="image/*" onchange="handleFileSelect()" style="padding: 5px 0;">
    <div class="evidence-area" id="filePreviewArea">
    <span style="color:#666; font-size:11px;">Nenhuma evid√™ncia selecionada.</span>
    </div>
    </div>
    </div>

    <div class="col-right">
    <div class="group-box">
    <div class="group-title">2. APLICA√á√ÉO DE MATERIAIS E SERVI√áOS</div>
    
    <div class="cart-controls">
    <div class="type-selector">
    <select id="selTipo" onchange="carregarOpcoes()" style="font-size:11px;">
    <option value="CLIENTE">MATERIAL CLIENTE</option>
    <option value="PROPRIO">MATERIAL PR√ìPRIO</option>
    <option value="SERVICO">SERVI√áOS</option>
    </select>
    </div>
    
    <div class="search-box">
    <input type="text" id="buscaRapida" 
    placeholder="üîç Buscar por c√≥digo ou descri√ß√£o..." 
    style="flex:1; padding:4px;"
    onkeyup="filtrarOpcoes()"
    onfocus="mostrarSugestoes()">
    <div id="sugestoesBox" class="suggestions-box"></div>
    </div>
    
    <div class="item-selector">
    <select id="selMaterial" size="5" style="flex:1; font-size:11px;">
    <option value="">Selecione um item...</option>
    </select>
    </div>
    
    <div class="quantity-controls">
    <span style="font-size:11px;">Qtd:</span>
    <input type="number" id="qtdMat" value="1" min="1" max="999" style="width:60px;">
    <button class="btn-98" onclick="adicionarItem()" style="font-size:11px; padding:4px 8px;">‚ûï ADD</button>
    </div>
    </div>

    <div class="cart-list" id="listaCarrinho">
    </div>
    <div style="font-size:10px; color:#666; margin-top:5px;">
    üí° <b>Dica:</b> Digite parte do c√≥digo ou nome para buscar rapidamente
    </div>
    </div>
    </div>
    </div>

    <div style="text-align:right; border-top:1px solid #999; padding-top:5px; display:flex; justify-content:flex-end; gap:8px;">
    
    <button class="btn-98" style="background:#008080; color:white; font-weight:bold; min-width:140px;" onclick="enviarRDO()">üìÑ ENVIAR RDO</button>
    <button class="btn-98" style="background:#ccffcc; font-weight:bold; min-width:180px;" onclick="concluirEmCampo()">‚úÖ CONCLU√çDA EM CAMPO</button>
    <button class="btn-98" id="btnRascunhado" style="background:#ffffcc; font-weight:bold; min-width:120px;" onclick="rascunhado()">üîí RASCUNHADO</button>

    <button class="btn-98" onclick="closeModal()">CANCELAR</button>
    <button class="btn-98 primary" onclick="salvar()">üíæ SALVAR DADOS</button>
    </div>
    </div>
    </div>
  </div>

<script>
  // CONFIGURA√á√ÉO
  // CONFIGURA√á√ÉO
  const API = 'https://script.google.com/macros/s/AKfycbwH6dek08S8I8dpKXWYZR7flENqCXJPqtX-OlJKd9jMuVBYAR1eC5-y-eJ4RztswNQq/exec';
  
  // Timeout para requisi√ß√µes (ms)
  const REQUEST_TIMEOUT = 30000;
  
  // VARI√ÅVEIS GLOBAIS
  let CATALOGO = { materiais: [], servicos: [] };
  let CARRINHO = [];
  let TODOS_ITENS = []; 
  let ITENS_FILTRADOS = [];
  let USER_IS_ANALYST = false; // NOVA VARI√ÅVEL DE PERMISS√ÉO
  let UPLOADED_FILES = []; // Array para armazenar arquivos selecionados
  
  // ====
  // FUN√á√ïES DE CONTROLE DA JANELA
  // ====
  function minimizeApp() {
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('taskbarBtn').style.display = 'block';
  }
  
  function restoreApp() {
    document.getElementById('mainApp').style.display = 'flex';
    document.getElementById('taskbarBtn').style.display = 'none';
  }

  function toggleMaximize() {
    const app = document.getElementById('mainApp');
    if (app.style.maxWidth === 'none' || app.style.maxWidth === '') {
    app.style.maxWidth = '1400px';
    app.style.height = '98vh';
    app.style.width = '98%';
    } else {
    app.style.maxWidth = 'none';
    app.style.width = '100vw';
    app.style.height = '100vh';
    }
  }

  function closeApp() {
    if(confirm("Deseja fechar o Painel Gerencial?")) {
    window.close();
    }
  }

  // ====
  // SISTEMA DE LOGIN E PERMISS√ÉO
  // ====
  
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  function checkLoginState() {
    const user = sessionStorage.getItem('usuarioSID');
    if (user) {
    document.getElementById('telaLogin').style.display = 'none';
    document.getElementById('mainApp').style.display = 'flex';
    document.getElementById('userDisplay').textContent = "Usu√°rio: " + user;

    // Chama a checagem de permiss√£o (agora a fun√ß√£o est√° definida abaixo)
    checkAnalystPermission(user); 
    carregarCatalogo(); // Chama a fun√ß√£o de cat√°logo (agora a fun√ß√£o est√° definida abaixo)
    
    const obraId = getQueryParam('obra_id');
    if (obraId) {
    document.getElementById('termo').value = obraId;
    setTimeout(buscar, 500); 
    }
    } else {
    // Inicializa o estado do bot√£o RASCUNHADO como desativado por padr√£o
    const btn = document.getElementById('btnRascunhado');
    if (btn) btn.disabled = true;
    }
  }

  function checkAnalystPermission(email) {
    jsonp('verificar_permissao', { email: email }, function(resposta) {
    USER_IS_ANALYST = resposta.isAnalista || false;
    
    const btn = document.getElementById('btnRascunhado');
    if (btn) {
    if (USER_IS_ANALYST) {
    btn.disabled = false;
    btn.textContent = 'üîí RASCUNHADO';
    btn.style.opacity = 1.0;
    btn.title = "A√ß√£o exclusiva do Analista.";
    } else {
    btn.disabled = true;
    btn.textContent = 'üîí RASCUNHADO';
    btn.style.opacity = 0.5;
    btn.title = "A√ß√£o restrita ao Analista de Dados.";
    }
    }
    });
  }

  function login() {
    const email = document.getElementById('emailLogin').value;
    if(!email.includes('@')) {
    alert('E-mail inv√°lido');
    return;
    }
    
    jsonp('login', {email: email}, function(resposta) {
    if(resposta.sucesso) {
    document.getElementById('telaLogin').style.display = 'none';
    document.getElementById('mainApp').style.display = 'flex';
    sessionStorage.setItem('usuarioSID', email);
    document.getElementById('userDisplay').textContent = "Usu√°rio: " + email;
    checkAnalystPermission(email);
    carregarCatalogo();
    } else {
    alert(resposta.msg || 'Erro no login');
    }
    });
  }
  
  // ====
  // GEST√ÉO DE ARQUIVOS (EVID√äNCIAS) - NOVO
  // ====
  function handleFileSelect() {
    const input = document.getElementById('fileUpload');
    const area = document.getElementById('filePreviewArea');
    
    // Se a chamada n√£o veio do input, apenas renderiza o que j√° temos
    if (input && input.files && input.files.length > 0) {
    UPLOADED_FILES = Array.from(input.files);
    }
    
    if (UPLOADED_FILES.length > 10) {
    alert(`Voc√™ selecionou ${UPLOADED_FILES.length} arquivos. O m√°ximo permitido √© 10.`);
    UPLOADED_FILES = UPLOADED_FILES.slice(0, 10);
    }
    
    area.innerHTML = '';
    if (UPLOADED_FILES.length === 0) {
    area.innerHTML = '<span style="color:#666; font-size:11px;">Nenhuma evid√™ncia selecionada.</span>';
    return;
    }
    
    UPLOADED_FILES.forEach((file, index) => {
    const div = document.createElement('div');
    div.className = 'file-preview';
    div.innerHTML = `${index + 1}. ${file.name.substring(0, 15)}... <span class="remove-btn" onclick="removeFile(${index})">X</span>`;
    area.appendChild(div);
    });
  }
  
  function removeFile(index) {
    UPLOADED_FILES.splice(index, 1);
    handleFileSelect(); // Renderiza novamente
  }
  
  function uploadFilesToDrive(callback) {
    if (UPLOADED_FILES.length === 0) {
      callback([]);
      return;
    }

    const codObra = document.getElementById('hdnCod').value;
    if (!codObra) {
      alert('‚ùå C√≥digo da obra n√£o encontrado. N√£o foi poss√≠vel enviar as fotos.');
      callback(null);
      return;
    }

    const data = new FormData();
    data.append('codObra', codObra);

    // Limita a 10 arquivos
    const filesToUpload = UPLOADED_FILES.slice(0, 10);
    filesToUpload.forEach((file, index) => {
      data.append('file' + index, file);
    });

    const btnEnviar = document.querySelector('.modal-content button[onclick="enviarRDO()"]');
    const textoOriginal = btnEnviar ? btnEnviar.textContent : 'ENVIAR RDO';
    if (btnEnviar) {
      btnEnviar.textContent = '‚¨ÜÔ∏è Enviando Fotos...';
      btnEnviar.disabled = true;
    }

    console.log('Iniciando upload de ' + filesToUpload.length + ' arquivos para a obra ' + codObra);

    fetch(API + '?acao=upload_evidencias&codObra=' + encodeURIComponent(codObra), {
      method: 'POST',
      body: data
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('HTTP error! status: ' + response.status);
      }
      return response.json();
    })
    .then(response => {
      console.log('Resposta do upload:', response);
      if (btnEnviar) {
        btnEnviar.textContent = textoOriginal;
        btnEnviar.disabled = false;
      }
      if (response && response.sucesso) {
        callback(response.fileUrls || []);
      } else {
        const errorMsg = response && response.mensagem ? response.mensagem : 'Falha desconhecida no upload.';
        alert('‚ùå Erro no upload: ' + errorMsg);
        callback(null);
      }
    })
    .catch(error => {
      console.error('Erro de rede/upload:', error);
      if (btnEnviar) {
        btnEnviar.textContent = textoOriginal;
        btnEnviar.disabled = false;
      }
      alert('‚ùå Erro de comunica√ß√£o durante o upload: ' + error.message);
      callback(null);
    });
  }
  
  // ====
  // SISTEMA DE CAT√ÅLOGO COM BUSCA R√ÅPIDA - RESTAURADO
  // ====
  function carregarCatalogo() {
    console.log('Carregando cat√°logo...');
    jsonp('listar_catalogos', {}, function(resposta) {
    console.log('Resposta do cat√°logo:', resposta);
    
    CATALOGO.materiais = resposta.materiais || [];
    CATALOGO.servicos = resposta.servicos || [];
    
    // Prepara lista completa para busca
    TODOS_ITENS = [];
    
    // Adiciona materiais
    CATALOGO.materiais.forEach(item => {
    TODOS_ITENS.push({
    tipo: item.origem,
    codigo: item.cod,
    descricao: item.desc,
    unidade: item.unid,
    categoria: 'MATERIAL'
    });
    });
    
    // Adiciona servi√ßos
    CATALOGO.servicos.forEach(item => {
    TODOS_ITENS.push({
    tipo: 'SERVICO',
    codigo: item.cod,
    descricao: item.desc,
    unidade: item.unid || 'UN',
    categoria: 'SERVICO'
    });
    });
    
    console.log('Total de itens carregados:', TODOS_ITENS.length);
    
    carregarOpcoes();
    });
  }

  function carregarOpcoes() {
    const tipo = document.getElementById('selTipo').value;
    const select = document.getElementById('selMaterial');
    
    select.innerHTML = '';
    
    // Filtra itens pelo tipo selecionado
    ITENS_FILTRADOS = TODOS_ITENS.filter(item => {
    if (tipo === 'SERVICO') {
    return item.categoria === 'SERVICO';
    } else {
    return item.tipo === tipo;
    }
    });
    
    console.log(`Carregando ${ITENS_FILTRADOS.length} itens para ${tipo}`);
    
    // Ordena por c√≥digo
    ITENS_FILTRADOS.sort((a, b) => a.codigo.localeCompare(b.codigo));
    
    // Adiciona ao select
    ITENS_FILTRADOS.forEach(item => {
    const option = document.createElement('option');
    option.value = item.codigo;
    option.textContent = `${item.codigo} - ${item.descricao} (${item.unidade})`;
    option.setAttribute('data-desc', item.descricao);
    option.setAttribute('data-unid', item.unidade);
    option.setAttribute('data-tipo', item.tipo);
    select.appendChild(option);
    });
    
    // Seleciona primeiro item se houver
    if (ITENS_FILTRADOS.length > 0) {
    select.selectedIndex = 0;
    }
    
    document.getElementById('qtdMat').value = 1;
    document.getElementById('buscaRapida').value = '';
    document.getElementById('sugestoesBox').style.display = 'none';
  }

  // FUN√á√ÉO DE BUSCA R√ÅPIDA
  function filtrarOpcoes() {
    const termo = document.getElementById('buscaRapida').value.toUpperCase().trim();
    const select = document.getElementById('selMaterial');
    const tipoAtual = document.getElementById('selTipo').value;
    
    if (!termo) {
    carregarOpcoes();
    document.getElementById('sugestoesBox').style.display = 'none';
    return;
    }
    
    // Filtra itens
    const resultados = TODOS_ITENS.filter(item => {
    const filtroTipo = tipoAtual === 'SERVICO' ? item.categoria === 'SERVICO' : item.tipo === tipoAtual;
    const buscaCodigo = item.codigo.toUpperCase().includes(termo);
    const buscaDescricao = item.descricao.toUpperCase().includes(termo);
    
    return filtroTipo && (buscaCodigo || buscaDescricao);
    });
    
    // Atualiza select
    select.innerHTML = '';
    resultados.forEach(item => {
    const option = document.createElement('option');
    option.value = item.codigo;
    option.textContent = `${item.codigo} - ${item.descricao} (${item.unidade})`;
    option.setAttribute('data-desc', item.descricao);
    option.setAttribute('data-unid', item.unidade);
    option.setAttribute('data-tipo', item.tipo);
    select.appendChild(option);
    });
    
    // Mostra sugest√µes
    mostrarSugestoes(termo);
    
    // Seleciona primeiro item se houver
    if (resultados.length > 0) {
    select.selectedIndex = 0;
    }
  }

  // MOSTRAR SUGEST√ïES DE BUSCA
  function mostrarSugestoes(termo) {
    const input = document.getElementById('buscaRapida');
    const box = document.getElementById('sugestoesBox');
    const tipoAtual = document.getElementById('selTipo').value;
    
    if (!input.value.trim()) {
    box.style.display = 'none';
    return;
    }
    
    termo = termo || input.value.toUpperCase().trim();
    
    // Filtra sugest√µes
    const sugestoes = TODOS_ITENS.filter(item => {
    const filtroTipo = tipoAtual === 'SERVICO' ? item.categoria === 'SERVICO' : item.tipo === tipoAtual;
    const buscaCodigo = item.codigo.toUpperCase().includes(termo);
    const buscaDescricao = item.descricao.toUpperCase().includes(termo);
    
    return filtroTipo && (buscaCodigo || buscaDescricao);
    }).slice(0, 10); // Limita a 10 sugest√µes
    
    if (sugestoes.length === 0) {
    box.style.display = 'none';
    return;
    }
    
    // Posiciona a caixa de sugest√µes
    const rect = input.getBoundingClientRect();
    box.style.position = 'fixed';
    box.style.left = rect.left + 'px';
    box.style.top = (rect.bottom + window.scrollY) + 'px';
    box.style.width = rect.width + 'px';
    
    // Preenche sugest√µes
    box.innerHTML = '';
    sugestoes.forEach((item, index) => {
    const div = document.createElement('div');
    div.className = 'suggestion-item';
    div.textContent = `${item.codigo} - ${item.descricao}`;
    div.onclick = function() {
    input.value = item.codigo;
    box.style.display = 'none';
    
    // Seleciona o item no select
    const select = document.getElementById('selMaterial');
    for (let i = 0; i < select.options.length; i++) {
    if (select.options[i].value === item.codigo) {
    select.selectedIndex = i;
    break;
    }
    }
    };
    box.appendChild(div);
    });
    
    box.style.display = 'block';
  }

  // ESCONDER SUGEST√ïES AO CLICAR FORA
  document.addEventListener('click', function(e) {
    const box = document.getElementById('sugestoesBox');
    const input = document.getElementById('buscaRapida');
    
    if (box && !box.contains(e.target) && e.target !== input) {
    box.style.display = 'none';
    }
  });

  function adicionarItem() {
    const select = document.getElementById('selMaterial');
    const quantidade = parseInt(document.getElementById('qtdMat').value);
    
    if (!select.value || select.selectedIndex === -1) {
    alert('Selecione um item primeiro!');
    return;
    }
    
    if (quantidade < 1 || quantidade > 999) {
    alert('Quantidade deve ser entre 1 e 999!');
    return;
    }
    
    const codigo = select.value;
    const descricao = select.options[select.selectedIndex].getAttribute('data-desc');
    const unidade = select.options[select.selectedIndex].getAttribute('data-unid');
    const tipo = select.options[select.selectedIndex].getAttribute('data-tipo') || document.getElementById('selTipo').value;
    
    CARRINHO.push({
    tipo: tipo,
    codigo: codigo,
    descricao: descricao,
    quantidade: quantidade,
    unidade: unidade
    });
    
    atualizarCarrinho();
    
    document.getElementById('qtdMat').value = 1;
    document.getElementById('buscaRapida').value = '';
    document.getElementById('sugestoesBox').style.display = 'none';
    
    // Volta para lista completa
    carregarOpcoes();
  }

  function removerItem(index) {
    CARRINHO.splice(index, 1);
    atualizarCarrinho();
  }

  function atualizarCarrinho() {
    const container = document.getElementById('listaCarrinho');
    container.innerHTML = '';
    
    if (CARRINHO.length === 0) {
    container.innerHTML = '<div style="color:#888; text-align:center; padding:10px;">Nenhum item adicionado</div>';
    return;
    }
    
    CARRINHO.forEach((item, index) => {
    const div = document.createElement('div');
    div.className = 'cart-item';
    div.innerHTML = `
    <span><b>${item.quantidade}x</b> [${item.tipo}] ${item.codigo} - ${item.descricao} (${item.unidade})</span>
    <span class="cart-del" onclick="removerItem(${index})" title="Remover">‚úñ</span>
    `;
    container.appendChild(div);
    });
  }
  
  // ====
  // SISTEMA DE BUSCA E EDI√á√ÉO
  // ====
  function buscar() {
    const termo = document.getElementById('termo').value.trim();
    if (!termo) return;
    
    const tbody = document.getElementById('tbResult').querySelector('tbody');
    // Colspan corrigido para 10 colunas
    tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:20px;">Buscando...</td></tr>'; 
    
    jsonp('resolver_obra', {termo: termo}, function(resposta) {
    tbody.innerHTML = '';
    
    if (!resposta.obras || resposta.obras.length === 0) {
    tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:20px;">Nenhuma obra encontrada</td></tr>'; 
    return;
    }
    
    resposta.obras.forEach(obra => {
    const safeData = encodeURIComponent(JSON.stringify(obra));
    
    let corStatus = "#eee";
    if (obra.STATUS && obra.STATUS.includes("PENDENTE")) corStatus = "#ffff99";
    if (obra.STATUS && obra.STATUS.includes("CONCLU√çDO")) corStatus = "#99ff99";
    
    const txtMascara = (obra.MASCARA_BA || '').substring(0, 25) + (obra.MASCARA_BA && obra.MASCARA_BA.length > 25 ? '...' : '');
    const txtAplicacao = (obra.APLICACAO_FEITA || '').substring(0, 25) + (obra.APLICACAO_FEITA && obra.APLICACAO_FEITA.length > 25 ? '...' : '');
    const txtPendencia = (obra.PENDENCIA_DEVOLUCAO || '').substring(0, 25) + (obra.PENDENCIA_DEVOLUCAO && obra.PENDENCIA_DEVOLUCAO.length > 25 ? '...' : '');
    
    const linha = `
    <tr>
    <td><b>${obra.COD_OBRA_NUM || ''}</b></td>
    <td>${obra.OPERADORA || ''}</td>
    <td>${obra.DESCRICAO || ''}</td>
    <td><span class="status-badge" style="background:${corStatus}">${obra.STATUS || ''}</span></td>
    <td>${obra.SUPERVISOR || ''}</td>
    <td>${obra.TECNICO || 'N/D'}</td> 
    <td style="color:#000080; font-size:10px;">${txtMascara}</td>
    <td style="font-size:10px;">${txtAplicacao}</td>
    <td style="color:red; font-weight:bold; font-size:10px;">${txtPendencia}</td>
    <td style="text-align:center">
    <button class="btn-98" onclick="abrirModal('${safeData}')">üìù ABRIR</button>
    </td>
    </tr>
    `;
    
    tbody.innerHTML += linha;
    });
    });
  }

  function abrirModal(dadosCodificados) {
    const obra = JSON.parse(decodeURIComponent(dadosCodificados));
    
    // 1. Preenche a Ficha T√©cnica
    document.getElementById('hdnCod').value = obra.COD_OBRA_NUM;
    document.getElementById('vID').textContent = obra.COD_OBRA_NUM || '-';
    document.getElementById('vDesc').textContent = obra.DESCRICAO || '-';
    document.getElementById('vOp').textContent = obra.OPERADORA || '-';
    document.getElementById('vSt').textContent = obra.STATUS || '-';
    document.getElementById('vSup').textContent = obra.SUPERVISOR || '-';
    document.getElementById('vTec').textContent = obra.TECNICO || '-'; 

    // 2. Preenche os Textareas
    document.getElementById('txtMas').value = obra.MASCARA_BA || '';
    document.getElementById('txtPen').value = obra.PENDENCIA_DEVOLUCAO || '';
    
    // 3. Carrega Carrinho
    CARRINHO = [];
    if (obra.APLICACAO_FEITA && obra.APLICACAO_FEITA.trim() !== '') {
    const itens = obra.APLICACAO_FEITA.split('|').map(item => item.trim()).filter(item => item !== '');
    
    itens.forEach(item => {
    const match = item.match(/\[(.*?)\]\s*(\d+)x\s+(.+?)\s+\((.*?)\)/);
    if (match) {
    CARRINHO.push({
    tipo: match[1],
    quantidade: parseInt(match[2]),
    descricao: match[3],
    codigo: match[4],
    unidade: 'UN'
    });
    }
    });
    }
    
    atualizarCarrinho();
    
    // 4. Limpa a √°rea de Evid√™ncias (Fotos)
    UPLOADED_FILES = [];
    // Resetando o input de arquivo diretamente √© mais garantido em navegadores
    const fileInput = document.getElementById('fileUpload');
    if(fileInput) fileInput.value = '';
    
    handleFileSelect(); // Renderiza o preview vazio
    
    // 5. Abre o Modal
    document.getElementById('modalEdicao').style.display = 'flex';
    
    // 6. Foca no campo de busca
    setTimeout(() => {
    document.getElementById('buscaRapida').focus();
    }, 100);
  }

  function closeModal() {
    document.getElementById('modalEdicao').style.display = 'none';
    CARRINHO = [];
  }
  
  // ====
  // FUN√á√ïES DE A√á√ÉO R√ÅPIDA E SALVAMENTO
  // ====

  function validarCamposObrigatorios() {
    const mascara = document.getElementById('txtMas').value.trim();
    const carrinhoVazio = CARRINHO.length === 0;
    
    if (!mascara) {
    alert('üõë O campo M√ÅSCARA / RELAT√ìRIO T√âCNICO √© obrigat√≥rio para CONCLUIR/ENVIAR RDO.');
    document.getElementById('txtMas').focus();
    return false;
    }
    if (carrinhoVazio) {
    if (!confirm("‚ö†Ô∏è Aten√ß√£o: O CARRINHO DE MATERIAIS est√° vazio. Deseja prosseguir mesmo assim?")) {
    return false;
    }
    }
    return true;
  }
  
  function concluirEmCampo() {
    if (!validarCamposObrigatorios()) return;
    
    const marcador = "STATUS: CONCLUIDA EM CAMPO em " + new Date().toLocaleDateString('pt-BR');
    document.getElementById('txtPen').value = marcador; 
    
    salvar();
  }

  function rascunhado() {
    // A valida√ß√£o de Analista √© feita ao carregar o modal no checkAnalystPermission
    const marcador = "STATUS: RASCUNHADO SALVO em " + new Date().toLocaleDateString('pt-BR') + ' ' + new Date().toLocaleTimeString('pt-BR');
    
    const valorAtualPen = document.getElementById('txtPen').value;
    document.getElementById('txtPen').value = marcador + '\n--- RAS. ANTERIOR ---\n' + valorAtualPen;
    
    salvar();
  }
  
  function enviarRDO() {
    // Valida√ß√£o estrita:
    if (!validarCamposObrigatorios()) return;

    if (UPLOADED_FILES.length === 0) {
      if (!confirm("‚ö†Ô∏è O RDO ser√° enviado SEM EVID√äNCIAS (FOTOS). Deseja prosseguir com o envio?")) {
        return;
      }
    }

    const codObra = document.getElementById('hdnCod').value;
    if (!codObra) {
      alert("‚ùå C√≥digo da obra n√£o encontrado.");
      return;
    }

    // 1. UPLOAD DE FOTOS PARA O DRIVE
    console.log("Iniciando processo de envio do RDO para a obra " + codObra);
    uploadFilesToDrive(function(fileUrls) {
      if (fileUrls === null) {
        alert("‚ùå Falha cr√≠tica no upload das fotos. RDO n√£o enviado.");
        return;
      }

      // 2. CHAMA O SALVAMENTO E GERA√á√ÉO DE PDF
      const mascara = document.getElementById('txtMas').value;
      const pendencia = document.getElementById('txtPen').value;

      let aplicacaoTexto = '';
      if (CARRINHO.length > 0) {
        aplicacaoTexto = CARRINHO.map(item => {
          return `[${item.tipo}] ${item.quantidade}x ${item.descricao} (${item.codigo})`;
        }).join(' | ');
      }

      // Passa as URLs das fotos para o GAS para gerar o PDF
      const urlsString = fileUrls.join(' | ');

      const btnEnviar = document.querySelector('.modal-content button[onclick="enviarRDO()"]');
      const textoOriginal = btnEnviar ? btnEnviar.textContent : 'ENVIAR RDO';
      if (btnEnviar) {
        btnEnviar.textContent = 'üìÑ Gerando PDF...';
        btnEnviar.disabled = true;
      }

      console.log("Enviando dados para gera√ß√£o do RDO:", {
        codObra: codObra,
        mascaraBa: mascara,
        aplicacaoFeita: aplicacaoTexto,
        pendencia: pendencia,
        fileUrls: urlsString
      });

      // Chama a nova a√ß√£o do GAS para SALVAR + GERAR PDF + ENVIAR
      jsonp('gerar_rdo_e_enviar', {
        codObra: codObra,
        mascaraBa: mascara,
        aplicacaoFeita: aplicacaoTexto,
        pendencia: pendencia,
        fileUrls: urlsString
      }, function(resposta) {
        console.log("Resposta do envio do RDO:", resposta);
        if (btnEnviar) {
          btnEnviar.textContent = textoOriginal;
          btnEnviar.disabled = false;
        }

        if (resposta && resposta.sucesso) {
          alert(`‚úÖ RDO enviado com sucesso! PDF gerado e notificado.`);
          closeModal();
          buscar();
        } else {
          const errorMsg = resposta && resposta.mensagem ? resposta.mensagem : 'Falha desconhecida.';
          alert('‚ùå Erro no envio do RDO: ' + errorMsg);
        }
      });
    });
  }

  function salvar() {
    const codObra = document.getElementById('hdnCod').value;
    if (!codObra) {
      alert("‚ùå C√≥digo da obra n√£o encontrado.");
      return;
    }
    const mascara = document.getElementById('txtMas').value;
    const pendencia = document.getElementById('txtPen').value;
    
    let aplicacaoTexto = '';
    if (CARRINHO.length > 0) {
      aplicacaoTexto = CARRINHO.map(item => {
        return `[${item.tipo}] ${item.quantidade}x ${item.descricao} (${item.codigo})`;
      }).join(' | ');
    }
    
    console.log('=== SALVANDO DADOS ===', {
      codObra: codObra,
      mascaraBa: mascara,
      aplicacaoFeita: aplicacaoTexto,
      pendencia: pendencia
    });
    const btnSalvar = document.querySelector('.modal-content .primary');
    const textoOriginal = btnSalvar.textContent;
    btnSalvar.textContent = 'üíæ Salvando...';
    btnSalvar.disabled = true;
    
    jsonp('atualizar_anotacoes_obra', {
      codObra: codObra,
      mascaraBa: mascara,
      aplicacaoFeita: aplicacaoTexto,
      pendencia: pendencia
    }, function(resposta) {
      btnSalvar.textContent = textoOriginal;
      btnSalvar.disabled = false;
      
      if (resposta && resposta.sucesso) {
        alert('‚úÖ Dados salvos com sucesso!');
        // Ap√≥s salvar, dispara notifica√ß√£o
        notificarAtualizacao(codObra, mascara, aplicacaoTexto, pendencia);
        closeModal();
        buscar();
      } else {
        const errorMsg = resposta && resposta.mensagem ? resposta.mensagem : 'Falha ao salvar';
        alert('‚ùå Erro: ' + errorMsg);
      }
    });
  }
  
  // ====
  // FUN√á√ÉO JSONP PARA COMUNICA√á√ÉO
  // ====
  function jsonp(acao, params, callback) {
    const nomeCallback = 'callback_' + Date.now() + '_' + Math.random().toString(36).substr(2);
    
    window[nomeCallback] = function(resposta) {
      delete window[nomeCallback];
      const script = document.getElementById(nomeCallback); // Busca pelo ID
      if(script) document.body.removeChild(script);
      callback(resposta);
    };
    
    const parametros = new URLSearchParams(params);
    parametros.set('acao', acao);
    parametros.set('callback', nomeCallback);
    
    const url = API + '?' + parametros.toString();
    console.log("Chamando JSONP:", url, params);
    
    const script = document.createElement('script');
    script.src = url;
    script.id = nomeCallback; // Adiciona ID para remover depois
    script.onerror = function() {
      console.error("Erro ao carregar script JSONP:", url);
      delete window[nomeCallback];
      if(script && script.parentNode) script.parentNode.removeChild(script);
      callback({ sucesso: false, mensagem: "Erro de conex√£o com o servidor." });
    };
    document.body.appendChild(script);
  }

  // Nova fun√ß√£o para notificar atualiza√ß√£o (disparo ass√≠ncrono)
  function notificarAtualizacao(codObra, mascara, aplicacao, pendencia) {
    // Dispara notifica√ß√£o de forma ass√≠ncrona sem afetar o fluxo principal
    console.log("Disparando notifica√ß√£o para obra " + codObra);
    jsonp('notificar_atualizacao_obra', {
      codObra: codObra,
      mascaraBa: mascara,
      aplicacaoFeita: aplicacao,
      pendencia: pendencia
    }, function(resposta) {
      console.log("Notifica√ß√£o enviada:", resposta);
    });
  }
</script>
</body>
</html>