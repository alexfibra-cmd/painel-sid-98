<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>SID 98 - Enterprise (v6.9)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* --- CORE WINDOWS 98 STYLES --- */
    :root { --win-grey:#c0c0c0; --win-blue:#000080; }
    body { font-family:'Tahoma',sans-serif; background:#008080; margin:0; height:100vh; overflow:hidden; display:flex; justify-content:center; align-items:center; }
    
    .win-window { background:var(--win-grey); border:2px outset #fff; box-shadow:4px 4px 10px rgba(0,0,0,0.5); display:flex; flex-direction:column; }
    .title-bar { background:linear-gradient(90deg,var(--win-blue),#1084d0); color:#fff; padding:3px 4px; font-weight:bold; font-size:13px; display:flex; justify-content:space-between; align-items:center; }
    
    /* WINDOW CONTROLS */
    .controls-group { display:flex; gap:2px; }
    .btn-win {
      background:var(--win-grey); border:1px outset #fff; width:18px; height:18px;
      font-size:10px; line-height:1; font-weight:bold; cursor:pointer; text-align:center;
      color:#000;
    }
    .btn-win:hover { background: #e0e0e0; }
    .btn-win.close { color: #d00000; font-size: 12px; }
    .btn-win:active { border-style:inset; }

    /* LAYOUT */
    #mainApp { width:98%; height:98vh; max-width:1400px; display:none; } 
    .app-body { flex:1; display:flex; padding:8px; gap:8px; overflow:hidden; }
    .sidebar { width:220px; display:flex; flex-direction:column; gap:6px; }
    .nav-btn { width: 100%; text-align: left; padding: 8px; display: flex; align-items: center; gap: 8px; }
    .nav-btn.active { background: #fff; border-style: inset; font-weight: bold; }
    .nav-btn.disabled { color: #666; cursor: not-allowed; }

    .content-area { flex:1; background:#fff; border:2px inset #fff; display:flex; flex-direction:column; }
    
    /* TABELA */
    .table-container { flex:1; overflow:auto; }
    table { width:100%; border-collapse:collapse; font-size:11px; }
    th { background:var(--win-grey); position:sticky; top:0; text-align:left; border:1px outset #fff; padding:5px; z-index:10; }
    td { border:1px solid #ddd; padding:5px; } 
    tr:hover { background:#000080; color:#fff; }
    .status-badge { padding: 2px 5px; border-radius: 3px; font-weight: bold; font-size: 10px; border: 1px solid #999; }

    /* MODAL GIGANTE */
    .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:9999; }
    .modal-box { width:95%; height:95%; background:var(--win-grey); }
    .modal-content { padding:10px; height:100%; display:flex; flex-direction:column; gap:10px; }
    
    .info-grid { display:grid; grid-template-columns:repeat(5,1fr); background:#e0e0e0; border:2px inset #fff; padding:5px; }
    .info-item span { display:block; color:#000080; font-weight:bold; font-size:11px; }
    
    /* EDITOR GRID */
    .editor-layout { flex:1; display:grid; grid-template-columns: 1fr 1fr; gap:10px; overflow:hidden; }
    .col-left, .col-right { display:flex; flex-direction:column; gap:10px; }
    .group-box { border:1px solid #999; padding:5px; display:flex; flex-direction:column; background:#f0f0f0; flex:1; }
    textarea { width:100%; border:2px inset #fff; font-family:'Courier New'; resize:none; flex:1; padding:5px; }
    
    /* TASKBAR BUTTON STYLE */
    .btn-taskbar { background:var(--win-grey); border:2px outset #fff; padding: 5px 15px; font-weight: bold; font-size: 14px; cursor: pointer; }
    .btn-taskbar:active { border-style: inset; }

  </style>
</head>
<body onload="checkLoginState()">

  <div id="taskbarBtn" style="position:fixed; bottom:10px; right:10px; z-index:9999; display:none;">
      <button class="btn-taskbar" onclick="restoreApp()">üñ•Ô∏è SID 98</button>
  </div>
  
  <div id="telaLogin" class="win-window" style="width:300px;">
    <div class="title-bar"><span>üîí Login SID 98</span></div>
    <div style="padding:20px;">
      <label style="font-size:11px; font-weight:bold;">E-mail Corporativo:</label>
      <input type="text" id="emailLogin" style="width:100%; margin-bottom:10px; padding:4px;">
      <button class="btn-98 primary" style="width:100%" onclick="login()">ENTRAR</button>
    </div>
  </div>

  <div id="mainApp" class="win-window">
    <div class="title-bar" id="appTitleBar">
      <span>GERENCIA OPERACIONAL BACKBONE</span>
      <div class="controls-group">
          <div class="btn-win" onclick="minimizeApp()">_</div>
          <div class="btn-win" onclick="toggleMaximize()">‚ñ°</div>
          <div class="btn-win close" onclick="closeApp()">X</div>
      </div>
    </div>
    
    <div class="app-body">
      <div class="sidebar">
        <div style="border:2px groove #fff; padding:5px; margin-bottom:5px;">
          <input type="text" id="termo" placeholder="ID ou Nome..." style="width:100%; padding:3px;" onkeydown="if(event.key=='Enter') buscar()">
          <button class="btn-98" style="width:100%; margin-top:4px;" onclick="buscar()">üîé Localizar</button>
        </div>

        <button class="btn-98 nav-btn active" onclick="alert('M√≥dulo Ativo')">
          üõ†Ô∏è <b>SEG.55 - MANUTEN√á√ÉO</b>
        </button>
        
        <button class="btn-98 nav-btn disabled" onclick="alert('üöß M√≥dulo SEG.63 em Constru√ß√£o!')">
          üì° SEG.63 - MELHORIA (DC)
        </button>
        
        <button class="btn-98 nav-btn disabled" onclick="alert('üöß M√≥dulo Financeiro em Constru√ß√£o!')">
          üí∞ SALDO GESTECH GERENCIAL
        </button>
        
        <button class="btn-98 nav-btn disabled" onclick="alert('üöß M√≥dulo Escala em Constru√ß√£o!')">
          üìÖ ESCALA PLANT√ÉO T√âCNICO
        </button>

        <button class="btn-98 nav-btn disabled" onclick="alert('üöß M√≥dulo Supervis√£o em Constru√ß√£o!')">
          üëÆ SUPERVISORES PLANT√ÉO
        </button>
      </div>

      <div class="content-area">
        <div class="table-container">
          <table id="tbResult">
            <thead>
              <tr>
                <th width="8%">ID</th>
                <th width="8%">Operadora</th>
                <th width="20%">Descri√ß√£o</th>
                <th width="10%">Status</th>
                <th width="10%">Supervisor</th>
                <th width="15%">M√°scara BA</th>
                <th width="10%">Aplica√ß√£o</th>
                <th width="10%">Pend√™ncia</th>
                <th width="8%" style="text-align:center">A√ß√£o</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="msgInicial" style="padding:50px; text-align:center; color:#888;">
            <p>Utilize a busca lateral para carregar as obras do SEG.55.</p>
          </div>
        </div>
      </div>
    </div>
    
    <div style="background:var(--win-grey); border-top:2px groove #fff; padding:2px 5px; font-size:10px; display:flex; justify-content:space-between;">
      <span>Base Conectada: BASE_DASH_OBRAS</span>
      <span>Status: Online v6.9</span>
    </div>
  </div>

  <div id="modalEdicao" class="modal-overlay">
    <div class="modal-box win-window">
      <div class="title-bar">
        <span id="lblModalTitulo">FICHA T√âCNICA</span>
        <div class="controls-group">
            <div class="btn-win" onclick="closeModal()">X</div>
        </div>
      </div>
      
      <div class="modal-content">
        <input type="hidden" id="hdnCod">
        
        <div class="info-grid">
          <div class="info-item"><label>ID:</label><span id="vID">-</span></div>
          <div class="info-item"><label>DESC:</label><span id="vDesc">-</span></div>
          <div class="info-item"><label>OP:</label><span id="vOp">-</span></div>
          <div class="info-item"><label>STATUS:</label><span id="vSt">-</span></div>
          <div class="info-item"><label>SUP:</label><span id="vSup">-</span></div>
        </div>

        <div class="editor-layout">
          <div class="col-left">
            <div class="group-box">
              <div class="group-title">1. M√ÅSCARA / RELAT√ìRIO T√âCNICO</div>
              <textarea id="txtMas" placeholder="Descreva o servi√ßo..."></textarea>
            </div>
            <div class="group-box" style="background:#fff0f0; border-color:red;">
              <div class="group-title" style="color:red;">3. PEND√äNCIAS / DEVOLU√á√ÉO</div>
              <textarea id="txtPen" placeholder="Motivo de devolu√ß√£o..."></textarea>
            </div>
          </div>

          <div class="col-right">
            <div class="group-box">
              <div class="group-title">2. APLICA√á√ÉO DE MATERIAIS E SERVI√áOS</div>
              <div class="cart-controls">
                <select id="selTipo" onchange="filtrarCatalogo()" style="font-size:11px;">
                  <option value="CLIENTE">MATERIAL CLIENTE</option>
                  <option value="PROPRIO">MATERIAL PR√ìPRIO</option>
                  <option value="SERVICO">SERVI√áOS</option>
                </select>
                <input type="text" id="buscaMat" list="dlMateriais" placeholder="Item..." style="flex:1;">
                <datalist id="dlMateriais"></datalist>
                <input type="number" id="qtdMat" value="1" style="width:40px;">
                <button class="btn-98" onclick="addCart()">ADD</button>
              </div>

              <div class="cart-list" id="listaCarrinho"></div>
              <div style="font-size:10px; color:#666;">* Lista ser√° salva no campo Aplica√ß√£o.</div>
            </div>
          </div>
        </div>

        <div style="text-align:right; border-top:1px solid #999; padding-top:5px;">
          <button class="btn-98" onclick="closeModal()">CANCELAR</button>
          <button class="btn-98 primary" onclick="salvar()">üíæ SALVAR DADOS</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // VERIFIQUE SE O LINK EST√Å CORRETO
  const API = 'https://script.google.com/macros/s/AKfycbwH6dek08S8I8dpKXWYZR7flENqCXJPqtX-OlJKd9jMuVBYAR1eC5-y-eJ4RztswNQq/exec';
  
  let CATALOGO = { mat:[], serv:[] };
  let CARRINHO = [];

  // --- FUN√á√ïES DE CONTROLE DE JANELA (CORRIGIDAS) ---
  function minimizeApp() {
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('taskbarBtn').style.display = 'block'; // Mostra o bot√£o da Taskbar
  }
  
  function restoreApp() {
      document.getElementById('mainApp').style.display = 'flex';
      document.getElementById('taskbarBtn').style.display = 'none'; // Esconde o bot√£o da Taskbar
  }

  function toggleMaximize() {
    const app = document.getElementById('mainApp');
    if (app.style.maxWidth === 'none' || app.style.maxWidth === '') {
      app.style.maxWidth = '1400px';
      app.style.height = '98vh';
      app.style.width = '98%';
    } else {
      app.style.maxWidth = 'none';
      app.style.width = '100vw';
      app.style.height = '100vh';
    }
  }
  function closeApp() {
    if(confirm("Deseja fechar o Painel Gerencial? Voc√™ ter√° que fazer login novamente.")) {
        window.close();
    }
  }
  function checkLoginState() {
      // Verifica se o usu√°rio j√° fez login antes
      const user = sessionStorage.getItem('usuarioSID');
      if (user) {
          document.getElementById('telaLogin').style.display = 'none';
          document.getElementById('mainApp').style.display = 'flex';
          document.getElementById('userDisplay').textContent = user;
          carregarCatalogo(); 
      }
  }

  // --- LOGIN ---
  function login() {
    const email = document.getElementById('emailLogin').value;
    if(!email.includes('@')) return alert('E-mail inv√°lido');
    jsonp('login', {email:email}, r => {
      if(r.sucesso) {
        document.getElementById('telaLogin').style.display = 'none';
        document.getElementById('mainApp').style.display = 'flex';
        document.getElementById('userDisplay').textContent = email;
        sessionStorage.setItem('usuarioSID', email);
        carregarCatalogo();
      } else alert(r.msg);
    });
  }

  // --- CAT√ÅLOGO ---
  function carregarCatalogo() {
    jsonp('listar_catalogos', {}, r => {
      CATALOGO.mat = r.materiais || [];
      CATALOGO.serv = r.servicos || [];
      filtrarCatalogo();
    });
  }

  function filtrarCatalogo() {
    let tipo = document.getElementById('selTipo').value;
    let dl = document.getElementById('dlMateriais');
    dl.innerHTML = '';
    let lista = (tipo === 'SERVICO') ? CATALOGO.serv : CATALOGO.mat.filter(m => m.origem === tipo);
    lista.forEach(i => {
      let op = document.createElement('option');
      op.value = i.desc; op.label = i.cod;
      dl.appendChild(op);
    });
    document.getElementById('buscaMat').value = '';
  }

  function addCart() {
    let nome = document.getElementById('buscaMat').value;
    let qtd = document.getElementById('qtdMat').value;
    let tipo = document.getElementById('selTipo').value;
    if(!nome || qtd<=0) return;
    
    // Procura o c√≥digo do material/servi√ßo no datalist antes de adicionar (melhor controle)
    const datalist = document.getElementById('dlMateriais');
    let codigo = '';
    for (let i = 0; i < datalist.options.length; i++) {
        if (datalist.options[i].value === nome) {
            codigo = datalist.options[i].label; // O c√≥digo est√° no label
            break;
        }
    }
    
    CARRINHO.push({ tipo, nome, qtd, cod: codigo });
    renderCart();
    document.getElementById('buscaMat').value = '';
    document.getElementById('qtdMat').value = 1;
  }

  function renderCart() {
    let div = document.getElementById('listaCarrinho');
    div.innerHTML = '';
    CARRINHO.forEach((item, idx) => {
      let row = document.createElement('div');
      row.className = 'cart-item';
      row.innerHTML = `<span>[${item.tipo}] ${item.qtd}x ${item.nome} (${item.cod})</span> <span class="cart-del" onclick="delCart(${idx})">X</span>`;
      div.appendChild(row);
    });
  }

  function delCart(idx) { CARRINHO.splice(idx, 1); renderCart(); }

  // --- BUSCA E MODAL ---
  function buscar() {
    let t = document.getElementById('termo').value;
    if(!t) return;
    document.getElementById('tbResult').querySelector('tbody').innerHTML = '<tr><td colspan="9">Buscando...</td></tr>';
    jsonp('resolver_obra', {termo:t}, r => {
      let tb = document.getElementById('tbResult').querySelector('tbody');
      tb.innerHTML = '';
      if(!r.obras.length) return tb.innerHTML='<tr><td colspan="9">Nada encontrado.</td></tr>';
      r.obras.forEach(o => {
        let safe = encodeURIComponent(JSON.stringify(o));
        let corStatus = "#eee";
        if(o.STATUS.includes("PENDENTE")) corStatus = "#ffff99";
        if(o.STATUS.includes("CONCLU√çDO")) corStatus = "#99ff99";
        
        let txtMas = (o.MASCARA_BA||'').substring(0,25) + '...';
        let txtApl = (o.APLICACAO_FEITA||'').substring(0,25) + '...';
        let txtPen = (o.PENDENCIA_DEVOLUCAO||'').substring(0,25) + '...';

        tb.innerHTML += `<tr>
          <td><b>${o.COD_OBRA_NUM}</b></td>
          <td>${o.OPERADORA}</td>
          <td>${o.DESCRICAO}</td>
          <td><span class="status-badge" style="background:${corStatus}">${o.STATUS}</span></td>
          <td>${o.SUPERVISOR}</td>
          <td style="color:#000080;font-size:10px;">${txtMas}</td>
          <td style="font-size:10px;">${txtApl}</td>
          <td style="color:red;font-weight:bold;font-size:10px;">${txtPen}</td>
          <td style="text-align:center">
            <button class="btn-98" onclick="openModal('${safe}')">üìù ABRIR</button>
            <button class="btn-98" onclick="alert('Funcionalidade Detalhar em constru√ß√£o.')">Detalhar</button>
          </td>
        </tr>`;
      });
    });
  }

  function openModal(safe) {
    let o = JSON.parse(decodeURIComponent(safe));
    document.getElementById('hdnCod').value = o.COD_OBRA_NUM;
    document.getElementById('vID').textContent = o.COD_OBRA_NUM;
    document.getElementById('vDesc').textContent = o.DESCRICAO;
    document.getElementById('vOp').textContent = o.OPERADORA;
    document.getElementById('vSt').textContent = o.STATUS;
    document.getElementById('vSup').textContent = o.SUPERVISOR;
    
    document.getElementById('txtMas').value = o.MASCARA_BA || '';
    document.getElementById('txtPen').value = o.PENDENCIA_DEVOLUCAO || '';
    
    CARRINHO = [];
    if(o.APLICACAO_FEITA) {
      let itens = o.APLICACAO_FEITA.split('|');
      itens.forEach(i => {
        let match = i.trim().match(/\[(.*?)\] (\d+)x (.*?) (\((.*?)\))?$/);
        if(match) CARRINHO.push({ tipo:match[1], qtd:match[2], nome:match[3], cod:match[5] || '' });
        else if(i.trim()) CARRINHO.push({ tipo:'TXT', qtd:1, nome:i.trim() });
      });
    }
    renderCart();
    document.getElementById('modalEdicao').style.display = 'flex';
  }

  function closeModal() { document.getElementById('modalEdicao').style.display = 'none'; }

  function salvar() {
    let cod = document.getElementById('hdnCod').value;
    let mas = document.getElementById('txtMas').value;
    let pen = document.getElementById('txtPen').value;
    
    // Converte Carrinho para String formatada [TIPO] QTDx NOME (COD)
    let aplTexto = CARRINHO.map(i => {
        let nome = i.nome.trim();
        let codDisplay = i.cod ? ` (${i.cod})` : '';
        return `[${i.tipo}] ${i.qtd}x ${nome}${codDisplay}`;
    }).join(' | ');

    let btn = document.querySelector('.modal-content .primary');
    let txt = btn.textContent; btn.textContent="..."; btn.disabled=true;

    jsonp('atualizar_anotacoes_obra', {codObra:cod, mascaraBa:mas, aplicacaoFeita:aplTexto, pendencia:pen}, r => {
      btn.textContent=txt; btn.disabled=false;
      if(r.sucesso) { alert('Salvo!'); closeModal(); buscar(); }
      else alert(r.mensagem);
    });
  }

  function jsonp(acao, params, cb) {
    let n = 'cb_'+Date.now();
    window[n] = (r) => { delete window[n]; document.body.removeChild(s); cb(r); };
    let q = Object.keys(params).map(k=>k+'='+encodeURIComponent(params[k])).join('&');
    let s = document.createElement('script');
    s.src = API + '?acao='+acao+'&callback='+n+(q?'&'+q:'');
    document.body.appendChild(s);
  }
</script>
</body>
</html>