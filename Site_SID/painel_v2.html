<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>SID 98 - Enterprise (v7.1 Final)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* --- CORE WINDOWS 98 STYLES --- */
    :root { --win-grey:#c0c0c0; --win-blue:#000080; }
    body { font-family:'Tahoma',sans-serif; background:#008080; margin:0; height:100vh; overflow:hidden; display:flex; justify-content:center; align-items:center; }
    
    .win-window { background:var(--win-grey); border:2px outset #fff; box-shadow:4px 4px 10px rgba(0,0,0,0.5); display:flex; flex-direction:column; }
    .title-bar { background:linear-gradient(90deg,var(--win-blue),#1084d0); color:#fff; padding:3px 4px; font-weight:bold; font-size:13px; display:flex; justify-content:space-between; align-items:center; }
    
    /* WINDOW CONTROLS */
    .controls-group { display:flex; gap:2px; }
    .btn-win { background:var(--win-grey); border:1px outset #fff; width:18px; height:18px; font-size:10px; line-height:1; font-weight:bold; cursor:pointer; text-align:center; color:#000; }
    .btn-win:hover { background: #e0e0e0; }
    .btn-win.close { color: #d00000; font-size: 12px; }
    .btn-win:active { border-style:inset; }

    /* LAYOUT */
    #mainApp { width:98%; height:98vh; max-width:1400px; display:none; } 
    .app-body { flex:1; display:flex; padding:8px; gap:8px; overflow:hidden; }
    .sidebar { width:220px; display:flex; flex-direction:column; gap:6px; }
    .nav-btn { width: 100%; text-align: left; padding: 8px; display: flex; align-items: center; gap: 8px; }
    .nav-btn.active { background: #fff; border-style: inset; font-weight: bold; }
    .nav-btn.disabled { color: #666; cursor: not-allowed; }

    .content-area { flex:1; background:#fff; border:2px inset #fff; display:flex; flex-direction:column; }
    
    /* TABELA */
    .table-container { flex:1; overflow:auto; }
    table { width:100%; border-collapse:collapse; font-size:11px; }
    th { background:var(--win-grey); position:sticky; top:0; text-align:left; border:1px outset #fff; padding:5px; z-index:10; }
    td { border:1px solid #ddd; padding:5px; } 
    tr:hover { background:#000080; color:#fff; }
    .status-badge { padding: 2px 5px; border-radius: 3px; font-weight: bold; font-size: 10px; border: 1px solid #999; }

    /* MODAL GIGANTE */
    .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:9999; }
    .modal-box { width:95%; height:95%; background:var(--win-grey); }
    .modal-content { padding:10px; height:100%; display:flex; flex-direction:column; gap:10px; }
    
    .info-grid { display:grid; grid-template-columns:repeat(5,1fr); background:#e0e0e0; border:2px inset #fff; padding:5px; }
    .info-item span { display:block; color:#000080; font-weight:bold; font-size:11px; }
    
    /* EDITOR GRID */
    .editor-layout { flex:1; display:grid; grid-template-columns: 1fr 1fr; gap:10px; overflow:hidden; }
    .col-left, .col-right { display:flex; flex-direction:column; gap:10px; }
    .group-box { border:1px solid #999; padding:5px; display:flex; flex-direction:column; background:#f0f0f0; flex:1; }
    textarea { width:100%; border:2px inset #fff; font-family:'Courier New'; resize:none; flex:1; padding:5px; }
    
    /* TASKBAR BUTTON STYLE */
    .btn-taskbar { background:var(--win-grey); border:2px outset #fff; padding: 5px 15px; font-weight: bold; font-size: 14px; cursor: pointer; }
    .btn-taskbar:active { border-style: inset; }

    /* CARRINHO DE MATERIAIS */
    .cart-controls { display:flex; gap:5px; margin-bottom:10px; }
    .cart-list { border:2px inset #fff; background:#fff; padding:5px; max-height:200px; overflow-y:auto; font-size:11px; }
    .cart-item { display:flex; justify-content:space-between; padding:3px; border-bottom:1px dotted #ccc; }
    .cart-del { color:red; cursor:pointer; font-weight:bold; }

  </style>
</head>
<body onload="checkLoginState()">

  <div id="taskbarBtn" style="position:fixed; bottom:10px; right:10px; z-index:9999; display:none;">
      <button class="btn-taskbar" onclick="restoreApp()">üñ•Ô∏è SID 98</button>
  </div>
  
  <div id="telaLogin" class="win-window" style="width:300px;">
    <div class="title-bar"><span>üîí Login SID 98</span></div>
    <div style="padding:20px;">
      <label style="font-size:11px; font-weight:bold;">E-mail Corporativo:</label>
      <input type="text" id="emailLogin" style="width:100%; margin-bottom:10px; padding:4px;">
      <button class="btn-98 primary" style="width:100%" onclick="login()">ENTRAR</button>
    </div>
  </div>

  <div id="mainApp" class="win-window">
    <div class="title-bar" id="appTitleBar">
      <span>GERENCIA OPERACIONAL BACKBONE</span>
      <div class="controls-group">
          <div class="btn-win" onclick="minimizeApp()">_</div>
          <div class="btn-win" onclick="toggleMaximize()">‚ñ°</div>
          <div class="btn-win close" onclick="closeApp()">X</div>
      </div>
    </div>
    
    <div class="app-body">
      <div class="sidebar">
        <div style="border:2px groove #fff; padding:5px; margin-bottom:5px;">
          <input type="text" id="termo" placeholder="ID ou Nome..." style="width:100%; padding:3px;" onkeydown="if(event.key=='Enter') buscar()">
          <button class="btn-98" style="width:100%; margin-top:4px;" onclick="buscar()">üîé Localizar</button>
        </div>

        <button class="btn-98 nav-btn active" onclick="alert('M√≥dulo Ativo')">
          üõ†Ô∏è <b>SEG.55 - MANUTEN√á√ÉO</b>
        </button>
        
        <button class="btn-98 nav-btn disabled" onclick="alert('üöß M√≥dulo SEG.63 em Constru√ß√£o!')">
          üì° SEG.63 - MELHORIA (DC)
        </button>
        
        <button class="btn-98 nav-btn disabled" onclick="alert('üöß M√≥dulo Financeiro em Constru√ß√£o!')">
          üí∞ SALDO GESTECH GERENCIAL
        </button>
        
        <button class="btn-98 nav-btn disabled" onclick="alert('üöß M√≥dulo Escala em Constru√ß√£o!')">
          üìÖ ESCALA PLANT√ÉO T√âCNICO
        </button>

        <button class="btn-98 nav-btn disabled" onclick="alert('üöß M√≥dulo Supervis√£o em Constru√ß√£o!')">
          üëÆ SUPERVISORES PLANT√ÉO
        </button>
      </div>

      <div class="content-area">
        <div class="table-container">
          <table id="tbResult">
            <thead>
              <tr>
                <th width="8%">ID</th>
                <th width="8%">Operadora</th>
                <th width="20%">Descri√ß√£o</th>
                <th width="10%">Status</th>
                <th width="10%">Supervisor</th>
                <th width="15%">M√°scara BA</th>
                <th width="10%">Aplica√ß√£o</th>
                <th width="10%">Pend√™ncia</th>
                <th width="8%" style="text-align:center">A√ß√£o</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="msgInicial" style="padding:50px; text-align:center; color:#888;">
            <p>Utilize a busca lateral para carregar as obras do SEG.55.</p>
          </div>
        </div>
      </div>
    </div>
    
    <div style="background:var(--win-grey); border-top:2px groove #fff; padding:2px 5px; font-size:10px; display:flex; justify-content:space-between;">
      <span>Base Conectada: BASE_DASH_OBRAS</span>
      <span>Status: Online v7.1</span>
    </div>
  </div>

  <div id="modalEdicao" class="modal-overlay">
    <div class="modal-box win-window">
      <div class="title-bar">
        <span id="lblModalTitulo">FICHA T√âCNICA</span>
        <div class="controls-group">
            <div class="btn-win" onclick="closeModal()">X</div>
        </div>
      </div>
      
      <div class="modal-content">
        <input type="hidden" id="hdnCod">
        
        <div class="info-grid">
          <div class="info-item"><label>ID:</label><span id="vID">-</span></div>
          <div class="info-item"><label>DESC:</label><span id="vDesc">-</span></div>
          <div class="info-item"><label>OP:</label><span id="vOp">-</span></div>
          <div class="info-item"><label>STATUS:</label><span id="vSt">-</span></div>
          <div class="info-item"><label>SUP:</label><span id="vSup">-</span></div>
        </div>

        <div class="editor-layout">
          <div class="col-left">
            <div class="group-box">
              <div class="group-title">1. M√ÅSCARA / RELAT√ìRIO T√âCNICO</div>
              <textarea id="txtMas" placeholder="Descreva o servi√ßo..."></textarea>
            </div>
            <div class="group-box" style="background:#fff0f0; border-color:red;">
              <div class="group-title" style="color:red;">3. PEND√äNCIAS / DEVOLU√á√ÉO</div>
              <textarea id="txtPen" placeholder="Motivo de devolu√ß√£o..."></textarea>
            </div>
          </div>

          <div class="col-right">
            <div class="group-box">
              <div class="group-title">2. APLICA√á√ÉO DE MATERIAIS E SERVI√áOS</div>
              
              <div class="cart-controls">
                <select id="selTipo" onchange="carregarOpcoes()" style="font-size:11px; width:120px;">
                  <option value="CLIENTE">MATERIAL CLIENTE</option>
                  <option value="PROPRIO">MATERIAL PR√ìPRIO</option>
                  <option value="SERVICO">SERVI√áOS</option>
                </select>
                <select id="selMaterial" style="font-size:11px; flex:1;">
                  <option value="">Selecione um item...</option>
                </select>
                <input type="number" id="qtdMat" value="1" min="1" style="width:60px; font-size:11px;">
                <button class="btn-98" onclick="adicionarItem()" style="font-size:11px;">ADD</button>
              </div>

              <div class="cart-list" id="listaCarrinho">
                <!-- Itens do carrinho aparecer√£o aqui -->
              </div>
              <div style="font-size:10px; color:#666; margin-top:5px;">
                * Adicione m√∫ltiplos materiais com suas quantidades
              </div>
            </div>
          </div>
        </div>

        <div style="text-align:right; border-top:1px solid #999; padding-top:5px;">
          <button class="btn-98" onclick="closeModal()">CANCELAR</button>
          <button class="btn-98 primary" onclick="salvar()">üíæ SALVAR DADOS</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // CONFIGURA√á√ÉO
  const API = 'https://script.google.com/macros/s/AKfycbwH6dek08S8I8dpKXWYZR7flENqCXJPqtX-OlJKd9jMuVBYAR1eC5-y-eJ4RztswNQq/exec';
  
  // VARI√ÅVEIS GLOBAIS
  let CATALOGO = { materiais: [], servicos: [] };
  let CARRINHO = [];

  // ============================================
  // FUN√á√ïES DE CONTROLE DA JANELA
  // ============================================
  function minimizeApp() {
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('taskbarBtn').style.display = 'block';
  }
  
  function restoreApp() {
    document.getElementById('mainApp').style.display = 'flex';
    document.getElementById('taskbarBtn').style.display = 'none';
  }

  function toggleMaximize() {
    const app = document.getElementById('mainApp');
    if (app.style.maxWidth === 'none' || app.style.maxWidth === '') {
      app.style.maxWidth = '1400px';
      app.style.height = '98vh';
      app.style.width = '98%';
    } else {
      app.style.maxWidth = 'none';
      app.style.width = '100vw';
      app.style.height = '100vh';
    }
  }

  function closeApp() {
    if(confirm("Deseja fechar o Painel Gerencial?")) {
      window.close();
    }
  }

  // ============================================
  // SISTEMA DE LOGIN
  // ============================================
  function checkLoginState() {
    const user = sessionStorage.getItem('usuarioSID');
    if (user) {
      document.getElementById('telaLogin').style.display = 'none';
      document.getElementById('mainApp').style.display = 'flex';
      document.getElementById('userDisplay').textContent = user;
      carregarCatalogo();
    }
  }

  function login() {
    const email = document.getElementById('emailLogin').value;
    if(!email.includes('@')) {
      alert('E-mail inv√°lido');
      return;
    }
    
    jsonp('login', {email: email}, function(resposta) {
      if(resposta.sucesso) {
        document.getElementById('telaLogin').style.display = 'none';
        document.getElementById('mainApp').style.display = 'flex';
        sessionStorage.setItem('usuarioSID', email);
        carregarCatalogo();
      } else {
        alert(resposta.msg || 'Erro no login');
      }
    });
  }

  // ============================================
  // SISTEMA DE CAT√ÅLOGO E CARRINHO (CORRIGIDO)
  // ============================================
  function carregarCatalogo() {
    console.log('Carregando cat√°logo...');
    jsonp('listar_catalogos', {}, function(resposta) {
      console.log('Resposta do cat√°logo:', resposta);
      
      CATALOGO.materiais = resposta.materiais || [];
      CATALOGO.servicos = resposta.servicos || [];
      
      console.log('Materiais carregados:', CATALOGO.materiais.length);
      console.log('Servi√ßos carregados:', CATALOGO.servicos.length);
      
      // Carrega as op√ß√µes inicialmente
      carregarOpcoes();
    });
  }

  function carregarOpcoes() {
    const tipo = document.getElementById('selTipo').value;
    const select = document.getElementById('selMaterial');
    
    // Limpa op√ß√µes anteriores
    select.innerHTML = '<option value="">Selecione um item...</option>';
    
    let lista = [];
    
    if (tipo === 'SERVICO') {
      lista = CATALOGO.servicos;
    } else {
      // Filtra materiais por origem
      lista = CATALOGO.materiais.filter(item => item.origem === tipo);
    }
    
    console.log(`Carregando op√ß√µes para ${tipo}: ${lista.length} itens`);
    
    // Adiciona op√ß√µes ao select
    lista.forEach(item => {
      const option = document.createElement('option');
      option.value = item.cod;
      option.textContent = `${item.cod} - ${item.desc} (${item.unid})`;
      option.setAttribute('data-desc', item.desc);
      option.setAttribute('data-unid', item.unid);
      select.appendChild(option);
    });
    
    // Reset quantidade
    document.getElementById('qtdMat').value = 1;
  }

  function adicionarItem() {
    const tipo = document.getElementById('selTipo').value;
    const select = document.getElementById('selMaterial');
    const quantidade = parseInt(document.getElementById('qtdMat').value);
    
    if (!select.value) {
      alert('Selecione um item primeiro!');
      return;
    }
    
    if (quantidade < 1) {
      alert('Quantidade deve ser pelo menos 1!');
      return;
    }
    
    const codigo = select.value;
    const descricao = select.options[select.selectedIndex].getAttribute('data-desc');
    const unidade = select.options[select.selectedIndex].getAttribute('data-unid');
    
    // Adiciona ao carrinho
    CARRINHO.push({
      tipo: tipo,
      codigo: codigo,
      descricao: descricao,
      quantidade: quantidade,
      unidade: unidade
    });
    
    // Atualiza a exibi√ß√£o do carrinho
    atualizarCarrinho();
    
    // Reseta os campos
    document.getElementById('qtdMat').value = 1;
    select.selectedIndex = 0;
  }

  function removerItem(index) {
    CARRINHO.splice(index, 1);
    atualizarCarrinho();
  }

  function atualizarCarrinho() {
    const container = document.getElementById('listaCarrinho');
    container.innerHTML = '';
    
    if (CARRINHO.length === 0) {
      container.innerHTML = '<div style="color:#888; text-align:center; padding:10px;">Nenhum item adicionado</div>';
      return;
    }
    
    CARRINHO.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'cart-item';
      div.innerHTML = `
        <span>${item.quantidade}x ${item.codigo} - ${item.descricao} (${item.unidade})</span>
        <span class="cart-del" onclick="removerItem(${index})">X</span>
      `;
      container.appendChild(div);
    });
  }

  // ============================================
  // SISTEMA DE BUSCA E EDI√á√ÉO
  // ============================================
  function buscar() {
    const termo = document.getElementById('termo').value.trim();
    if (!termo) return;
    
    const tbody = document.getElementById('tbResult').querySelector('tbody');
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:20px;">Buscando...</td></tr>';
    
    jsonp('resolver_obra', {termo: termo}, function(resposta) {
      tbody.innerHTML = '';
      
      if (!resposta.obras || resposta.obras.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:20px;">Nenhuma obra encontrada</td></tr>';
        return;
      }
      
      resposta.obras.forEach(obra => {
        const safeData = encodeURIComponent(JSON.stringify(obra));
        
        // Determina cor do status
        let corStatus = "#eee";
        if (obra.STATUS && obra.STATUS.includes("PENDENTE")) corStatus = "#ffff99";
        if (obra.STATUS && obra.STATUS.includes("CONCLU√çDO")) corStatus = "#99ff99";
        
        // Prepara textos curtos para exibi√ß√£o
        const txtMascara = (obra.MASCARA_BA || '').substring(0, 25) + (obra.MASCARA_BA && obra.MASCARA_BA.length > 25 ? '...' : '');
        const txtAplicacao = (obra.APLICACAO_FEITA || '').substring(0, 25) + (obra.APLICACAO_FEITA && obra.APLICACAO_FEITA.length > 25 ? '...' : '');
        const txtPendencia = (obra.PENDENCIA_DEVOLUCAO || '').substring(0, 25) + (obra.PENDENCIA_DEVOLUCAO && obra.PENDENCIA_DEVOLUCAO.length > 25 ? '...' : '');
        
        // Cria a linha da tabela
        const linha = `
          <tr>
            <td><b>${obra.COD_OBRA_NUM || ''}</b></td>
            <td>${obra.OPERADORA || ''}</td>
            <td>${obra.DESCRICAO || ''}</td>
            <td><span class="status-badge" style="background:${corStatus}">${obra.STATUS || ''}</span></td>
            <td>${obra.SUPERVISOR || ''}</td>
            <td style="color:#000080; font-size:10px;">${txtMascara}</td>
            <td style="font-size:10px;">${txtAplicacao}</td>
            <td style="color:red; font-weight:bold; font-size:10px;">${txtPendencia}</td>
            <td style="text-align:center">
              <button class="btn-98" onclick="abrirModal('${safeData}')">üìù ABRIR</button>
            </td>
          </tr>
        `;
        
        tbody.innerHTML += linha;
      });
    });
  }

  function abrirModal(dadosCodificados) {
    const obra = JSON.parse(decodeURIComponent(dadosCodificados));
    
    // Preenche informa√ß√µes b√°sicas
    document.getElementById('hdnCod').value = obra.COD_OBRA_NUM;
    document.getElementById('vID').textContent = obra.COD_OBRA_NUM || '-';
    document.getElementById('vDesc').textContent = obra.DESCRICAO || '-';
    document.getElementById('vOp').textContent = obra.OPERADORA || '-';
    document.getElementById('vSt').textContent = obra.STATUS || '-';
    document.getElementById('vSup').textContent = obra.SUPERVISOR || '-';
    
    // Preenche campos de texto
    document.getElementById('txtMas').value = obra.MASCARA_BA || '';
    document.getElementById('txtPen').value = obra.PENDENCIA_DEVOLUCAO || '';
    
    // Processa carrinho a partir da aplica√ß√£o salva
    CARRINHO = [];
    if (obra.APLICACAO_FEITA && obra.APLICACAO_FEITA.trim() !== '') {
      const itens = obra.APLICACAO_FEITA.split('|').map(item => item.trim()).filter(item => item !== '');
      
      itens.forEach(item => {
        // Tenta extrair informa√ß√µes do formato salvo
        const match = item.match(/(\d+)x\s+(.+?)\s+\((.*?)\)/);
        if (match) {
          CARRINHO.push({
            quantidade: parseInt(match[1]),
            descricao: match[2],
            codigo: match[3],
            tipo: 'MATERIAL',
            unidade: 'UN'
          });
        }
      });
    }
    
    atualizarCarrinho();
    document.getElementById('modalEdicao').style.display = 'flex';
  }

  function closeModal() {
    document.getElementById('modalEdicao').style.display = 'none';
    CARRINHO = [];
  }

  function salvar() {
    const codObra = document.getElementById('hdnCod').value;
    const mascara = document.getElementById('txtMas').value;
    const pendencia = document.getElementById('txtPen').value;
    
    // Converte carrinho para texto de aplica√ß√£o
    let aplicacaoTexto = '';
    if (CARRINHO.length > 0) {
      aplicacaoTexto = CARRINHO.map(item => {
        return `${item.quantidade}x ${item.descricao} (${item.codigo})`;
      }).join(' | ');
    }
    
    // Bot√£o de salvar
    const btnSalvar = document.querySelector('.modal-content .primary');
    const textoOriginal = btnSalvar.textContent;
    btnSalvar.textContent = 'Salvando...';
    btnSalvar.disabled = true;
    
    jsonp('atualizar_anotacoes_obra', {
      codObra: codObra,
      mascaraBa: mascara,
      aplicacaoFeita: aplicacaoTexto,
      pendencia: pendencia
    }, function(resposta) {
      btnSalvar.textContent = textoOriginal;
      btnSalvar.disabled = false;
      
      if (resposta.sucesso) {
        alert('Dados salvos com sucesso!');
        closeModal();
        buscar(); // Atualiza a lista
      } else {
        alert('Erro ao salvar: ' + (resposta.mensagem || 'Erro desconhecido'));
      }
    });
  }

  // ============================================
  // FUN√á√ÉO JSONP PARA COMUNICA√á√ÉO
  // ============================================
  function jsonp(acao, params, callback) {
    const nomeCallback = 'callback_' + Date.now() + '_' + Math.random().toString(36).substr(2);
    
    window[nomeCallback] = function(resposta) {
      delete window[nomeCallback];
      document.body.removeChild(script);
      callback(resposta);
    };
    
    const parametros = new URLSearchParams(params);
    parametros.set('acao', acao);
    parametros.set('callback', nomeCallback);
    
    const script = document.createElement('script');
    script.src = API + '?' + parametros.toString();
    document.body.appendChild(script);
  }
</script>
</body>
</html>