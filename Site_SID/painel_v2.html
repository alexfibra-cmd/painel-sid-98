<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>SID 98 - Enterprise (v5.3)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* ESTILOS BASE (WINDOWS 98) */
    :root { --win-grey:#c0c0c0; --win-blue:#000080; }
    body { font-family:'Tahoma',sans-serif; background:#008080; margin:0; height:100vh; overflow:hidden; display:flex; justify-content:center; align-items:center; }
    .win-window { background:var(--win-grey); border:2px outset #fff; display:flex; flex-direction:column; box-shadow:4px 4px 10px rgba(0,0,0,0.5); }
    .title-bar { background:linear-gradient(90deg,var(--win-blue),#1084d0); color:#fff; padding:4px; font-weight:bold; font-size:13px; display:flex; justify-content:space-between; }
    .btn-98 { background:var(--win-grey); border:2px outset #fff; padding:4px 10px; cursor:pointer; font-size:11px; }
    .btn-98:active { border-style:inset; } .primary { font-weight:bold; }
    
    /* LAYOUT */
    #mainApp { width:98%; height:98vh; display:none; }
    .app-body { flex:1; display:flex; padding:8px; gap:8px; overflow:hidden; }
    .sidebar { width:220px; display:flex; flex-direction:column; gap:8px; }
    .content-area { flex:1; background:#fff; border:2px inset #fff; display:flex; flex-direction:column; }
    .table-container { flex:1; overflow:auto; }
    table { width:100%; border-collapse:collapse; font-size:11px; }
    th { background:var(--win-grey); position:sticky; top:0; text-align:left; border:1px outset #fff; padding:5px; }
    td { border:1px solid #ddd; padding:5px; } tr:hover { background:#000080; color:#fff; }

    /* MODAL GIGANTE */
    .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:9999; }
    .modal-box { width:95%; height:95%; }
    .modal-content { padding:10px; height:100%; display:flex; flex-direction:column; gap:10px; }
    
    /* MODAL: INFO */
    .info-grid { display:grid; grid-template-columns:repeat(5,1fr); background:#e0e0e0; border:2px inset #fff; padding:5px; }
    .info-item span { display:block; color:#000080; font-weight:bold; font-size:11px; }

    /* MODAL: EDITOR GRID */
    .editor-layout { flex:1; display:grid; grid-template-columns: 1fr 1fr; gap:10px; overflow:hidden; }
    .col-left, .col-right { display:flex; flex-direction:column; gap:10px; }
    
    .group-box { border:1px solid #999; padding:5px; display:flex; flex-direction:column; background:#f0f0f0; flex:1; }
    .group-title { font-weight:bold; margin-bottom:5px; color:#000080; font-size:11px; }
    
    textarea { width:100%; border:2px inset #fff; font-family:'Courier New'; resize:none; flex:1; }
    
    /* CARRINHO DE MATERIAIS */
    .cart-controls { display:flex; gap:5px; margin-bottom:5px; align-items:center; flex-wrap:wrap; }
    .cart-list { border:2px inset #fff; background:#fff; flex:1; overflow-y:auto; font-family:'Courier New'; font-size:12px; padding:5px; }
    .cart-item { display:flex; justify-content:space-between; border-bottom:1px dotted #ccc; padding:2px; }
    .cart-item:hover { background:#eee; }
    .cart-del { color:red; cursor:pointer; font-weight:bold; margin-left:10px; }

  </style>
</head>
<body>

  <div id="telaLogin" class="win-window" style="width:300px;">
    <div class="title-bar"><span>üîí Login SID 98</span></div>
    <div style="padding:20px;">
      <label>E-mail:</label><input type="text" id="emailLogin" style="width:100%;margin-bottom:10px;">
      <button class="btn-98 primary" style="width:100%" onclick="login()">ENTRAR</button>
    </div>
  </div>

  <div id="mainApp" class="win-window">
    <div class="title-bar"><span>GER√äNCIA BACKBONE v5.3</span> <span id="userDisplay"></span></div>
    <div class="app-body">
      <div class="sidebar">
        <div style="border:2px groove #fff; padding:5px;">
          <input type="text" id="termo" placeholder="Buscar Obra..." style="width:100%" onkeydown="if(event.key=='Enter') buscar()">
          <button class="btn-98" style="width:100%; margin-top:2px;" onclick="buscar()">üîé Localizar</button>
        </div>
        <button class="btn-98 primary" style="text-align:left;">üõ†Ô∏è SEG.55 - MANUTEN√á√ÉO</button>
        <button class="btn-98" style="text-align:left; color:#888;">üì° SEG.63 (Em breve)</button>
      </div>
      <div class="content-area">
        <div class="table-container">
          <table id="tbResult"><thead><tr><th>ID</th><th>Operadora</th><th>Desc</th><th>Status</th><th>Sup</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </div>

  <div id="modalEdicao" class="modal-overlay">
    <div class="modal-box win-window">
      <div class="title-bar"><span>FICHA T√âCNICA</span><button class="btn-98" onclick="closeModal()">X</button></div>
      <div class="modal-content">
        <input type="hidden" id="hdnCod">
        <div class="info-grid">
          <div class="info-item"><label>ID:</label><span id="vID">-</span></div>
          <div class="info-item"><label>DESC:</label><span id="vDesc">-</span></div>
          <div class="info-item"><label>OP:</label><span id="vOp">-</span></div>
          <div class="info-item"><label>STATUS:</label><span id="vSt">-</span></div>
          <div class="info-item"><label>SUP:</label><span id="vSup">-</span></div>
        </div>

        <div class="editor-layout">
          <div class="col-left">
            <div class="group-box">
              <div class="group-title">1. M√ÅSCARA / RELAT√ìRIO T√âCNICO</div>
              <textarea id="txtMas" placeholder="Descreva o servi√ßo..."></textarea>
            </div>
            <div class="group-box" style="background:#fff0f0; border-color:red;">
              <div class="group-title" style="color:red;">3. PEND√äNCIAS / DEVOLU√á√ÉO</div>
              <textarea id="txtPen" placeholder="Motivo de devolu√ß√£o..."></textarea>
            </div>
          </div>

          <div class="col-right">
            <div class="group-box">
              <div class="group-title">2. APLICA√á√ÉO DE MATERIAIS E SERVI√áOS</div>
              
              <div class="cart-controls">
                <select id="selTipo" onchange="filtrarCatalogo()">
                  <option value="CLIENTE">MATERIAL CLIENTE (VTAL)</option>
                  <option value="PROPRIO">MATERIAL PR√ìPRIO (TEL)</option>
                  <option value="SERVICO">SERVI√áOS (LPU)</option>
                </select>
                <input type="text" id="buscaMat" list="dlMateriais" placeholder="Digite o item..." style="flex:1;">
                <datalist id="dlMateriais"></datalist>
                <input type="number" id="qtdMat" value="1" style="width:50px;">
                <button class="btn-98" onclick="addCart()">‚ûï ADD</button>
              </div>

              <div class="cart-list" id="listaCarrinho"></div>
              
              <div style="font-size:10px; color:#666; margin-top:2px;">* Itens adicionados ser√£o salvos no campo Aplica√ß√£o.</div>
            </div>
          </div>
        </div>

        <div style="text-align:right; border-top:1px solid #999; padding-top:5px;">
          <button class="btn-98" onclick="closeModal()">CANCELAR</button>
          <button class="btn-98 primary" onclick="salvar()">üíæ SALVAR DADOS</button>
        </div>
      </div>
    </div>
  </div>

<script>
  const API = 'https://script.google.com/macros/s/AKfycbwH6dek08S8I8dpKXWYZR7flENqCXJPqtX-OlJKd9jMuVBYAR1eC5-y-eJ4RztswNQq/exec';
  let CATALOGO = { mat:[], serv:[] };
  let CARRINHO = [];

  function login() {
    let m = document.getElementById('emailLogin').value;
    if(!m.includes('@')) return alert('E-mail inv√°lido');
    jsonp('login', {email:m}, r => {
      if(r.sucesso) {
        document.getElementById('telaLogin').style.display='none';
        document.getElementById('mainApp').style.display='flex';
        document.getElementById('userDisplay').textContent = m;
        carregarCatalogo(); // Carrega materiais no background
      } else alert(r.msg);
    });
  }

  function carregarCatalogo() {
    jsonp('listar_catalogos', {}, r => {
      CATALOGO.mat = r.materiais || [];
      CATALOGO.serv = r.servicos || [];
      filtrarCatalogo();
    });
  }

  function filtrarCatalogo() {
    let tipo = document.getElementById('selTipo').value;
    let dl = document.getElementById('dlMateriais');
    dl.innerHTML = '';
    let lista = (tipo === 'SERVICO') ? CATALOGO.serv : CATALOGO.mat.filter(m => m.origem === tipo);
    
    lista.forEach(i => {
      let op = document.createElement('option');
      op.value = i.desc; // Mostra nome
      op.label = i.cod;  // C√≥digo escondido
      dl.appendChild(op);
    });
    document.getElementById('buscaMat').value = '';
  }

  function addCart() {
    let nome = document.getElementById('buscaMat').value;
    let qtd = document.getElementById('qtdMat').value;
    let tipo = document.getElementById('selTipo').value;
    if(!nome || qtd<=0) return;

    CARRINHO.push({ tipo, nome, qtd });
    renderCart();
    document.getElementById('buscaMat').value = '';
    document.getElementById('qtdMat').value = 1;
  }

  function renderCart() {
    let div = document.getElementById('listaCarrinho');
    div.innerHTML = '';
    CARRINHO.forEach((item, idx) => {
      let row = document.createElement('div');
      row.className = 'cart-item';
      row.innerHTML = `<span>[${item.tipo}] ${item.qtd}x ${item.nome}</span> <span class="cart-del" onclick="delCart(${idx})">X</span>`;
      div.appendChild(row);
    });
  }

  function delCart(idx) {
    CARRINHO.splice(idx, 1);
    renderCart();
  }

  function buscar() {
    let t = document.getElementById('termo').value;
    if(!t) return;
    document.getElementById('tbResult').querySelector('tbody').innerHTML = '<tr><td colspan="6">Buscando...</td></tr>';
    jsonp('resolver_obra', {termo:t}, r => {
      let tb = document.getElementById('tbResult').querySelector('tbody');
      tb.innerHTML = '';
      if(!r.obras.length) return tb.innerHTML='<tr><td colspan="6">Nada encontrado.</td></tr>';
      r.obras.forEach(o => {
        let safe = encodeURIComponent(JSON.stringify(o));
        tb.innerHTML += `<tr><td>${o.COD_OBRA_NUM}</td><td>${o.OPERADORA}</td><td>${o.DESCRICAO}</td><td>${o.STATUS}</td><td>${o.SUPERVISOR}</td><td><button class="btn-98" onclick="openModal('${safe}')">EDITAR</button></td></tr>`;
      });
    });
  }

  function openModal(safe) {
    let o = JSON.parse(decodeURIComponent(safe));
    document.getElementById('hdnCod').value = o.COD_OBRA_NUM;
    document.getElementById('vID').textContent = o.COD_OBRA_NUM;
    document.getElementById('vDesc').textContent = o.DESCRICAO;
    document.getElementById('vOp').textContent = o.OPERADORA;
    document.getElementById('vSt').textContent = o.STATUS;
    document.getElementById('vSup').textContent = o.SUPERVISOR;
    
    document.getElementById('txtMas').value = o.MASCARA_BA || '';
    document.getElementById('txtPen').value = o.PENDENCIA_DEVOLUCAO || '';
    
    // Converte texto da Aplica√ß√£o de volta para Carrinho (Parser simples)
    CARRINHO = [];
    if(o.APLICACAO_FEITA) {
      // Tenta quebrar por Pipe |
      let itens = o.APLICACAO_FEITA.split('|');
      itens.forEach(i => {
        let match = i.trim().match(/\[(.*?)\] (\d+)x (.*)/);
        if(match) CARRINHO.push({ tipo:match[1], qtd:match[2], nome:match[3] });
        else if(i.trim()) CARRINHO.push({ tipo:'TXT', qtd:1, nome:i.trim() }); // Caso legado
      });
    }
    renderCart();
    
    document.getElementById('modalEdicao').style.display = 'flex';
  }

  function closeModal() { document.getElementById('modalEdicao').style.display = 'none'; }

  function salvar() {
    let cod = document.getElementById('hdnCod').value;
    let mas = document.getElementById('txtMas').value;
    let pen = document.getElementById('txtPen').value;
    
    // Converte Carrinho para String
    let aplTexto = CARRINHO.map(i => `[${i.tipo}] ${i.qtd}x ${i.nome}`).join(' | ');

    let btn = document.querySelector('.modal-content .primary');
    let txt = btn.textContent; btn.textContent="..."; btn.disabled=true;

    jsonp('atualizar_anotacoes_obra', {codObra:cod, mascaraBa:mas, aplicacaoFeita:aplTexto, pendencia:pen}, r => {
      btn.textContent=txt; btn.disabled=false;
      if(r.sucesso) { alert('Salvo!'); closeModal(); buscar(); }
      else alert(r.mensagem);
    });
  }

  function jsonp(acao, params, cb) {
    let n = 'cb_'+Date.now();
    window[n] = (r) => { delete window[n]; document.body.removeChild(s); cb(r); };
    let q = Object.keys(params).map(k=>k+'='+encodeURIComponent(params[k])).join('&');
    let s = document.createElement('script');
    s.src = API + '?acao='+acao+'&callback='+n+(q?'&'+q:'');
    document.body.appendChild(s);
  }
</script>
</body>
</html>