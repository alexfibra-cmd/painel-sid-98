<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>SID 98 - Ger√™ncia Operacional Backbone</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    /* --- CORE WINDOWS 98 STYLES --- */
    :root {
      --win-grey: #c0c0c0; --win-blue: #000080; --win-white: #ffffff; --win-black: #000000;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Tahoma', sans-serif; margin: 0; padding: 0;
      background-color: #008080; display: flex; justify-content: center; align-items: center;
      height: 100vh; overflow: hidden;
    }

    .win-window {
      background-color: var(--win-grey);
      border: 2px outset #fff; box-shadow: 4px 4px 10px rgba(0,0,0,0.5);
      display: flex; flex-direction: column;
    }

    .title-bar {
      background: linear-gradient(90deg, var(--win-blue), #1084d0);
      padding: 4px; display: flex; justify-content: space-between; align-items: center; color: white; font-weight: bold; font-size: 13px;
    }

    .btn-98 {
      background: var(--win-grey); border: 2px outset white;
      padding: 6px 12px; font-size: 12px; cursor: pointer; color: black;
    }
    .btn-98:active { border-style: inset; padding-top: 7px; }
    .btn-98.primary { font-weight: bold; }
    
    /* --- TELA DE LOGIN --- */
    #telaLogin {
      width: 350px; z-index: 10000;
    }
    
    /* --- TELA PRINCIPAL (DASHBOARD) --- */
    #mainApp { width: 98%; height: 98vh; max-width: 1400px; display: none; } /* Come√ßa oculto */

    .app-body { flex: 1; display: flex; padding: 8px; gap: 8px; overflow: hidden; }

    /* Menu Lateral (Segmentos) */
    .sidebar { width: 220px; display: flex; flex-direction: column; gap: 8px; }
    .nav-btn {
      width: 100%; text-align: left; padding: 10px; margin-bottom: 5px;
      display: flex; align-items: center; gap: 10px;
    }
    .nav-btn.active { background: #fff; border-style: inset; font-weight: bold; }
    .nav-btn.disabled { color: #888; cursor: not-allowed; }

    /* √Årea Central */
    .content-area { flex: 1; border: 2px inset white; background: white; display: flex; flex-direction: column; }
    
    /* Tabela */
    .table-container { flex: 1; overflow: auto; background: #fff; }
    table { width: 100%; border-collapse: collapse; font-size: 11px; }
    thead th { background: var(--win-grey); border: 1px outset white; padding: 5px; text-align: left; position: sticky; top: 0; z-index: 10; }
    td { border: 1px solid #ddd; padding: 5px; }
    tr:hover { background: #000080; color: white; }
    .status-badge { padding: 2px 5px; border-radius: 3px; font-weight: bold; font-size: 10px; border: 1px solid #999; }

    /* --- MODAL GIGANTE --- */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); z-index: 9999; display: none; justify-content: center; align-items: center;
    }
    .modal-box { width: 95%; height: 95%; background: var(--win-grey); }
    .modal-content { padding: 10px; height: 100%; display: flex; flex-direction: column; }

    .info-grid {
      display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px;
      background: #e0e0e0; border: 2px inset white; padding: 5px; margin-bottom: 5px;
    }
    .info-item label { font-size: 10px; font-weight: bold; color: #666; }
    .info-item span { display: block; font-weight: bold; color: #000080; font-size: 11px; }

    /* √Åreas de Edi√ß√£o (Os 3 Blocos) */
    .edit-grid {
      flex: 1; display: grid; grid-template-rows: 1fr 1fr 1fr; gap: 10px; overflow: hidden;
    }
    .edit-block { display: flex; flex-direction: column; border: 1px solid #999; padding: 5px; background: #f0f0f0; }
    .edit-block label { font-weight: bold; color: #000; margin-bottom: 3px; font-size: 12px; }
    
    textarea {
      flex: 1; width: 100%; border: 2px inset white; resize: none;
      font-family: 'Courier New', monospace; font-size: 14px; padding: 5px;
    }
    textarea:focus { background: #e6ffff; outline: none; }

    /* Cor Espec√≠fica para Pend√™ncia */
    .edit-block.alert { background: #ffe6e6; border-color: #ff0000; }
    .edit-block.alert label { color: #cc0000; }

  </style>
</head>
<body>

  <div id="telaLogin" class="win-window">
    <div class="title-bar"><span>üîí Acesso Restrito</span></div>
    <div style="padding: 20px;">
      <p style="font-size:12px; margin-top:0;">Identifique-se para acessar o Backbone:</p>
      <label style="font-size:11px; font-weight:bold;">E-mail Corporativo:</label>
      <input type="text" id="emailLogin" style="width:100%; margin-bottom:15px; padding:5px;">
      <button class="btn-98 primary" style="width:100%" onclick="fazerLogin()">ENTRAR NO SISTEMA</button>
      <p id="msgLogin" style="color:red; font-size:11px; min-height:15px; margin-bottom:0;"></p>
    </div>
  </div>

  <div id="mainApp" class="win-window">
    <div class="title-bar">
      <span>GERENCIA OPERACIONAL BACKBONE (v5.0)</span>
      <div style="font-size:11px;">Usu√°rio: <span id="userDisplay">---</span></div>
    </div>

    <div class="app-body">
      <div class="sidebar">
        <div style="padding:5px; border:2px groove #fff; margin-bottom:5px;">
          <label style="font-size:10px; color:#666;">BUSCAR OBRA (SEG.55):</label>
          <input type="text" id="termoBusca" placeholder="ID ou Descri√ß√£o..." style="width:100%" onkeydown="if(event.key==='Enter') buscarObras()">
          <button class="btn-98" style="width:100%; margin-top:3px;" onclick="buscarObras()">üîé Localizar</button>
        </div>

        <button class="btn-98 nav-btn active">
          üõ†Ô∏è <b>SEG.55 - MANUTEN√á√ÉO</b>
        </button>
        
        <button class="btn-98 nav-btn disabled" onclick="alert('M√≥dulo em Desenvolvimento.')">
          üì° RDO - MELHORIA (DC)
        </button>
        
        <button class="btn-98 nav-btn disabled" onclick="alert('M√≥dulo em Desenvolvimento.')">
          üí∞ SALDO GESTECH
        </button>
        
        <button class="btn-98 nav-btn disabled" onclick="alert('M√≥dulo em Desenvolvimento.')">
          üìÖ ESCALA PLANT√ÉO
        </button>
      </div>

      <div class="content-area">
        <div class="table-container">
          <table id="tabelaResultados">
            <thead>
              <tr>
                <th width="8%">ID</th>
                <th width="8%">Operadora</th>
                <th width="20%">Descri√ß√£o</th>
                <th width="10%">Status</th>
                <th width="10%">Supervisor</th>
                <th width="12%">M√°scara BA</th>
                <th width="12%">Aplica√ß√£o</th>
                <th width="10%">Pend√™ncia</th>
                <th width="8%" style="text-align:center">A√ß√£o</th>
              </tr>
            </thead>
            <tbody id="tbodyResultados"></tbody>
          </table>
          <div id="msgInicial" style="padding:50px; text-align:center; color:#888;">
            <p>Bem-vindo ao Painel Gerencial Backbone.</p>
            <p>Utilize a busca lateral para carregar as obras do SEG.55.</p>
          </div>
        </div>
      </div>
    </div>
    
    <div style="background:var(--win-grey); border-top:2px groove #fff; padding:2px 5px; font-size:10px;">
      Base Conectada: BASE_DASH_OBRAS | Status: Online
    </div>
  </div>

  <div id="modalEdicao" class="modal-overlay">
    <div class="modal-box win-window">
      <div class="title-bar">
        <span id="lblModalTitulo">FICHA DA OBRA</span>
        <button class="btn-98" style="padding:0 5px;" onclick="fecharModal()">X</button>
      </div>
      <div class="modal-content">
        <input type="hidden" id="hdnCodObra">

        <div class="info-grid">
          <div class="info-item"><label>ID:</label><span id="viewId">-</span></div>
          <div class="info-item"><label>DESCRI√á√ÉO:</label><span id="viewDesc">-</span></div>
          <div class="info-item"><label>OPERADORA:</label><span id="viewOperadora">-</span></div>
          <div class="info-item"><label>STATUS:</label><span id="viewStatus">-</span></div>
          <div class="info-item"><label>SUPERVISOR:</label><span id="viewSupervisor">-</span></div>
        </div>

        <div class="edit-grid">
          
          <div class="edit-block">
            <label>1. M√ÅSCARA DO BA (DESCRI√á√ÉO T√âCNICA DETALHADA):</label>
            <textarea id="txtMascara" placeholder="Descreva aqui o servi√ßo realizado no BA..."></textarea>
          </div>

          <div class="edit-block">
            <label>2. APLICA√á√ÉO DE MATERIAIS / SERVI√áOS:</label>
            <textarea id="txtAplicacao" placeholder="Listagem de materiais aplicados..."></textarea>
          </div>

          <div class="edit-block alert">
            <label>3. MOTIVO DE DEVOLU√á√ÉO / PEND√äNCIAS:</label>
            <textarea id="txtPendencia" placeholder="Se a obra foi devolvida, explique o motivo aqui..."></textarea>
          </div>

        </div>

        <div style="margin-top:10px; text-align:right;">
          <button class="btn-98" onclick="fecharModal()">CANCELAR</button>
          <button class="btn-98 primary" onclick="salvarEdicao()">üíæ SALVAR FICHA T√âCNICA</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // LINK DO SCRIPT (Verifique se √© o atual)
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwH6dek08S8I8dpKXWYZR7flENqCXJPqtX-OlJKd9jMuVBYAR1eC5-y-eJ4RztswNQq/exec';

  // --- LOGIN ---
  function fazerLogin() {
    const email = document.getElementById('emailLogin').value.trim();
    const btn = document.querySelector('#telaLogin button');
    const msg = document.getElementById('msgLogin');

    if(!email || !email.includes('@')) {
      msg.textContent = "Digite um e-mail v√°lido."; return;
    }

    btn.textContent = "Verificando...";
    btn.disabled = true;

    const cb = 'cb_login_' + Date.now();
    window[cb] = function(res) {
      delete window[cb]; document.body.removeChild(tag);
      
      if(res.sucesso) {
        document.getElementById('telaLogin').style.display = 'none';
        document.getElementById('mainApp').style.display = 'flex';
        document.getElementById('userDisplay').textContent = email;
        sessionStorage.setItem('usuarioSID', email);
      } else {
        msg.textContent = res.msg;
        btn.textContent = "ENTRAR NO SISTEMA";
        btn.disabled = false;
      }
    };

    const tag = document.createElement('script');
    tag.src = SCRIPT_URL + `?acao=login&email=${encodeURIComponent(email)}&callback=${cb}`;
    document.body.appendChild(tag);
  }

  // --- BUSCA ---
  function buscarObras() {
    const termo = document.getElementById('termoBusca').value.trim();
    const tbody = document.getElementById('tbodyResultados');
    const msg = document.getElementById('msgInicial');

    if(!termo) return alert("Digite algo para buscar.");

    tbody.innerHTML = '';
    msg.style.display = 'block';
    msg.innerHTML = 'Carregando SEG.55...';

    const cb = 'cb_busca_' + Date.now();
    window[cb] = function(res) {
      delete window[cb]; document.body.removeChild(tag);
      
      if(!res.sucesso) { msg.innerHTML = 'Erro: ' + res.mensagem; return; }
      if(res.obras.length === 0) { msg.innerHTML = 'Nenhuma obra encontrada.'; return; }

      msg.style.display = 'none';

      res.obras.forEach(o => {
        const safeData = encodeURIComponent(JSON.stringify(o));
        let corStatus = "#eee";
        if(o.STATUS.includes("PENDENTE")) corStatus = "#ffff99";
        if(o.STATUS.includes("CONCLU√çDO")) corStatus = "#99ff99";

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><b>${o.COD_OBRA_NUM}</b></td>
          <td>${o.OPERADORA}</td>
          <td>${o.DESCRICAO}</td>
          <td><span class="status-badge" style="background:${corStatus}">${o.STATUS}</span></td>
          <td>${o.SUPERVISOR}</td>
          <td style="color:#000080; font-size:10px;">${(o.MASCARA_BA||'').substring(0,30)}...</td>
          <td style="font-size:10px;">${(o.APLICACAO_FEITA||'').substring(0,30)}...</td>
          <td style="color:red; font-weight:bold; font-size:10px;">${(o.PENDENCIA_DEVOLUCAO||'').substring(0,30)}...</td>
          <td style="text-align:center"><button class="btn-98" onclick="abrirModal('${safeData}')">üìù ABRIR</button></td>
        `;
        tbody.appendChild(tr);
      });
    };

    const tag = document.createElement('script');
    tag.src = SCRIPT_URL + `?acao=resolver_obra&termo=${encodeURIComponent(termo)}&callback=${cb}`;
    document.body.appendChild(tag);
  }

  // --- MODAL ---
  function abrirModal(safeData) {
    const o = JSON.parse(decodeURIComponent(safeData));
    
    document.getElementById('hdnCodObra').value = o.COD_OBRA_NUM;
    document.getElementById('viewId').textContent = o.COD_OBRA_NUM;
    document.getElementById('viewDesc').textContent = o.DESCRICAO;
    document.getElementById('viewOperadora').textContent = o.OPERADORA;
    document.getElementById('viewStatus').textContent = o.STATUS;
    document.getElementById('viewSupervisor').textContent = o.SUPERVISOR;

    document.getElementById('txtMascara').value = o.MASCARA_BA || '';
    document.getElementById('txtAplicacao').value = o.APLICACAO_FEITA || '';
    document.getElementById('txtPendencia').value = o.PENDENCIA_DEVOLUCAO || ''; // NOVO

    document.getElementById('modalEdicao').style.display = 'flex';
  }

  function fecharModal() { document.getElementById('modalEdicao').style.display = 'none'; }

  function salvarEdicao() {
    const cod = document.getElementById('hdnCodObra').value;
    const mas = document.getElementById('txtMascara').value;
    const apl = document.getElementById('txtAplicacao').value;
    const pen = document.getElementById('txtPendencia').value;

    const btn = document.querySelector('#modalEdicao .primary');
    const txtOrig = btn.textContent;
    btn.textContent = "SALVANDO..."; btn.disabled = true;

    const cb = 'cb_save_' + Date.now();
    window[cb] = function(res) {
      delete window[cb]; document.body.removeChild(tag);
      btn.textContent = txtOrig; btn.disabled = false;
      if(res.sucesso) { alert("Salvo!"); fecharModal(); buscarObras(); }
      else { alert("Erro: " + res.mensagem); }
    };

    const tag = document.createElement('script');
    // Envia os 3 campos
    tag.src = SCRIPT_URL + `?acao=atualizar_anotacoes_obra&codObra=${encodeURIComponent(cod)}&mascaraBa=${encodeURIComponent(mas)}&aplicacaoFeita=${encodeURIComponent(apl)}&pendencia=${encodeURIComponent(pen)}&callback=${cb}`;
    document.body.appendChild(tag);
  }
</script>

</body>
</html>